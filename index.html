<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥å±€ç›¤é»ç³»çµ± v5.5 (é«˜å°æ¯”å„ªåŒ–ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/shim.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* UI åŸºç¤è¨­å®š */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f3f4f6; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
        }
        
        /* --- æ ¸å¿ƒå„ªåŒ–ï¼šè¼¸å…¥æ¡†æ¨£å¼ --- */
        .input-box { 
            @apply w-full h-16 rounded-xl text-center text-3xl font-extrabold outline-none transition-all p-0 shadow-sm;
            /* ä¿®æ­£ï¼šå¼·åˆ¶ç´”ç™½èƒŒæ™¯ï¼ŒåŠ ä¸Šæ·±ç°è‰²é‚Šæ¡†ï¼Œè®“å®ƒåœ¨å½©è‰²åº•åœ–ä¸Š"è·³"å‡ºä¾† */
            @apply bg-white border-2 border-gray-400 text-gray-900;
            -moz-appearance: textfield; 
        }
        
        /* é»æ“Šæ™‚çš„æ•ˆæœï¼šé‚Šæ¡†è®Šç²—è—è‰² */
        .input-box:focus { 
            @apply ring-4 ring-blue-300 border-blue-600 z-10; 
        }

        /* æœ‰è¼¸å…¥æ•¸å€¼æ™‚ï¼šæ–‡å­—è®Šè—ï¼Œå­—é«”åŠ é‡ */
        .input-filled { @apply text-blue-700 border-blue-500 font-black; }
        .input-empty { @apply text-gray-300; }
        
        /* éš±è—ç€è¦½å™¨é è¨­ç®­é ­ */
        .input-box::-webkit-outer-spin-button, .input-box::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* åŠ æ¸›æŒ‰éˆ•å„ªåŒ– */
        .btn-adj { 
            @apply w-12 h-16 flex items-center justify-center rounded-xl font-bold text-2xl transition-all border shadow-sm;
            @apply bg-white border-gray-300 text-gray-600 hover:bg-gray-100 active:bg-gray-300 active:scale-95;
        }

        /* --- é‡é»ä¿®æ­£ï¼šæ¬„ä½èƒŒæ™¯è‰²å¡Š (é¡è‰²åŠ æ·±ï¼Œå°æ¯”å¢å¼·) --- */
        /* col-zone: è¨­å®šç‚ºå¯é»æ“Šï¼Œä¸¦å¢åŠ å…§è·è®“æ‰‹æŒ‡å®¹æ˜“é»ä¸­ */
        .col-zone { @apply p-3 rounded-xl border-2 cursor-pointer transition-colors active:opacity-80; }
        
        .col-lg { @apply bg-blue-200 border-blue-300; }   /* å¤§åŒ…è£ï¼šæ˜é¡¯çš„è— */
        .col-sm { @apply bg-green-200 border-green-300; } /* å°åŒ…è£ï¼šæ˜é¡¯çš„ç¶  */
        .col-lo { @apply bg-orange-200 border-orange-300; } /* é›¶æ•£ï¼šæ˜é¡¯çš„æ©˜ */

        .btn-act { @apply active:scale-95 transition-transform; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .dot-green { background: #22c55e; box-shadow: 0 0 4px #22c55e; }
        .dot-red { background: #ef4444; }
        .custom-scroll { -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body>

<div id="crash-log" style="display:none; position:fixed; bottom:0; left:0; right:0; background:#7f1d1d; color:#fff; padding:10px; font-size:12px; z-index:9999; max-height:150px; overflow:auto;"></div>

<div id="app" class="w-full max-w-md mx-auto h-[100dvh] bg-white shadow-2xl flex flex-col relative border-x border-gray-200 overflow-hidden">

    <div v-if="page === 'admin'" class="flex-1 p-6 bg-gray-50 overflow-y-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">âš™ï¸ ç³»çµ±ç¶­è­·</h2>
        
        <div class="bg-red-50 p-4 rounded-lg border border-red-200 mb-6">
            <h3 class="font-bold text-red-800 mb-2">âš ï¸ å±éšªå€åŸŸ</h3>
            <button @click="resetDatabase" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow hover:bg-red-700 btn-act">ğŸ”¥ æ¸…ç©ºæ‰€æœ‰é›²ç«¯è³‡æ–™</button>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
            <h3 class="font-bold text-gray-700 mb-2">1. æ›´æ–°äººå“¡åå–®</h3>
            <input type="file" ref="fileStaff" accept=".csv,.txt" class="hidden" @change="uploadStaff">
            <button @click="$refs.fileStaff.click()" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-500 hover:text-blue-500 transition btn-act">é¸æ“‡äººå“¡ CSV</button>
            <div v-if="staffCount > 0" class="text-xs text-green-600 mt-2 text-center">ç›®å‰æœ‰ {{ staffCount }} ä½äººå“¡</div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
            <h3 class="font-bold text-gray-700 mb-2">2. æ›´æ–°ç›¤é»è¡¨</h3>
            <input type="file" ref="fileInv" multiple accept=".csv,.xlsx,.xls" class="hidden" @change="uploadInventory">
            <button @click="$refs.fileInv.click()" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-500 hover:text-blue-500 transition btn-act">é¸æ“‡ç›¤é»è¡¨ (æ”¯æ´å¤šæª”)</button>
            <div v-if="isUploading" class="mt-2 text-center text-blue-600 text-sm flex justify-center items-center gap-2"><div class="loader"></div> è™•ç†ä¸­...</div>
            <div v-if="dbCount > 0" class="text-xs text-green-600 mt-2 text-center">é›²ç«¯å·²æœ‰ {{ dbCount }} ç­†è—¥å“</div>
        </div>

        <button @click="page='home'" class="w-full bg-gray-600 text-white py-3 rounded-lg shadow hover:bg-gray-700 btn-act">è¿”å›é¦–é </button>
    </div>

    <div v-else-if="page === 'report'" class="flex-1 p-6 bg-gray-50 overflow-y-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">ğŸ“Š å ±è¡¨ä¸­å¿ƒ</h2>
        <div class="space-y-3 mb-6">
            <div v-for="z in zoneStats" :key="z.name" class="bg-white p-3 rounded shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <div class="font-bold text-gray-800">{{ z.name }}</div>
                        <div class="text-xs text-gray-500">{{ z.done }}/{{ z.total }} ({{ z.pct }}%)</div>
                    </div>
                    <button @click="exportZone(z.name)" class="text-xs px-3 py-1.5 rounded border transition btn-act" :class="z.pct===100 ? 'bg-green-100 text-green-800 border-green-300' : 'bg-gray-50 text-gray-600'">
                        {{ z.pct===100 ? 'âœ… å®Œæˆ' : 'ğŸ“¥ åŒ¯å‡º' }}
                    </button>
                </div>
                <div class="w-full bg-gray-200 h-1.5 rounded-full overflow-hidden">
                    <div class="h-full transition-all duration-500" :class="z.pct===100?'bg-green-500':(z.pct>50?'bg-yellow-400':'bg-red-500')" :style="{width: z.pct+'%'}"></div>
                </div>
            </div>
        </div>
        <button @click="exportTotal" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg shadow hover:bg-purple-700 mb-3 btn-act">åŒ¯å‡ºå…¨é™¢ç¸½è¡¨</button>
        <button @click="page='home'" class="w-full bg-gray-500 text-white py-3 rounded-lg shadow hover:bg-gray-600 btn-act">è¿”å›é¦–é </button>
    </div>

    <div v-else-if="page === 'home'" class="flex-1 flex flex-col justify-center items-center p-8 bg-blue-50 overflow-y-auto">
        <div class="w-full max-w-sm">
            <h1 class="text-3xl font-extrabold text-blue-900 text-center mb-1">è—¥å±€ç›¤é»ç³»çµ±</h1>
            <p class="text-center text-gray-400 text-xs mb-8 tracking-widest">FIREBASE V5.5</p>

            <div v-if="!isOnline" class="bg-red-100 text-red-700 p-3 rounded mb-4 text-center text-sm font-bold">é€£ç·šä¸­æ–·ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</div>

            <div v-if="dbCount === 0" class="bg-yellow-50 border border-yellow-200 p-4 rounded text-center mb-6">
                <p class="text-yellow-800 font-bold mb-1">å°šæœªå»ºç«‹è³‡æ–™åº«</p>
                <button @click="enterAdmin" class="text-xs bg-yellow-200 px-3 py-1.5 rounded text-yellow-800 hover:bg-yellow-300 btn-act">å‰å¾€å¾Œå°åŒ¯å…¥</button>
            </div>

            <div v-else>
                <label class="block text-gray-700 text-sm font-bold mb-1">ç›¤é»äººå“¡</label>
                <select v-model="selUser" class="w-full p-3 border rounded-lg bg-white shadow-sm mb-4 outline-none text-lg">
                    <option value="" disabled>-- è«‹é¸æ“‡äººå“¡ --</option>
                    <option v-for="u in staffList" :value="u">{{ u }}</option>
                </select>

                <label class="block text-gray-700 text-sm font-bold mb-1">ç›¤é»å€åŸŸ</label>
                <select v-model="selZone" class="w-full p-3 border rounded-lg bg-white shadow-sm mb-6 outline-none text-lg">
                    <option value="" disabled>-- è«‹é¸æ“‡å€åŸŸ --</option>
                    <option v-for="z in zoneList" :value="z">{{ z }}</option>
                </select>

                <button @click="startInv" :disabled="!selUser || !selZone" :class="(!selUser || !selZone) ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-blue-600 hover:bg-blue-700 shadow-lg'" class="w-full text-white font-bold py-3 rounded-lg transition btn-act mb-6 text-lg">
                    é–‹å§‹ç›¤é»
                </button>

                <div class="grid grid-cols-2 gap-3">
                    <button @click="page='report'" class="bg-white border text-gray-700 font-bold py-3 rounded-lg shadow-sm hover:bg-gray-50 btn-act">ğŸ“Š å ±è¡¨ä¸­å¿ƒ</button>
                    <button @click="enterAdmin" class="bg-white border text-gray-700 font-bold py-3 rounded-lg shadow-sm hover:bg-gray-50 btn-act">âš™ï¸ è³‡æ–™ç¶­è­·</button>
                </div>
                <div class="text-center mt-6 text-[10px] text-gray-300">Total: {{ dbCount }} items</div>
            </div>
        </div>
    </div>

    <div v-else class="flex-1 flex flex-col h-full overflow-hidden bg-gray-100">
        <div class="bg-blue-600 p-3 text-white shadow-md z-10 shrink-0">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <div class="font-bold text-lg leading-tight">{{ selUser }}</div>
                    <div class="text-xs text-blue-200">{{ selZone }}</div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex items-center text-[10px] bg-blue-700/80 px-2 py-1 rounded border border-blue-500">
                        <span class="dot" :class="isOnline ? 'dot-green' : 'dot-red'" style="width:6px; height:6px; margin-right:3px;"></span>
                        {{ isOnline ? 'é€£ç·š' : 'æ–·ç·š' }}
                    </div>
                    <div v-if="isSaving" class="text-xs text-blue-200 animate-pulse">â˜ï¸...</div>
                    <div v-else class="text-xs text-green-300 font-bold">âœ”åŒæ­¥</div>
                    <button @click="page='home'" class="bg-blue-800 border border-blue-500 px-3 py-1 rounded text-xs hover:bg-blue-700 btn-act">é›¢é–‹</button>
                </div>
            </div>
            
            <div class="flex justify-between text-xs text-blue-100 mb-1">
                <span>å®Œæˆé€²åº¦</span>
                <span>{{ currentProgress.done }}/{{ currentProgress.total }} ({{ currentProgress.pct }}%)</span>
            </div>
            <div class="w-full bg-blue-800 h-2 rounded-full overflow-hidden">
                <div class="bg-green-400 h-full transition-all duration-300" :style="{width: currentProgress.pct+'%'}"></div>
            </div>
            
            <div class="mt-2 relative">
                <input v-model="keyword" type="text" placeholder="æœå°‹è—¥åã€ä»£ç¢¼..." class="w-full pl-9 pr-8 py-2 rounded text-gray-800 text-sm outline-none shadow-inner">
                <div class="absolute left-3 top-2.5 text-gray-400 pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <button v-if="keyword" @click="keyword=''" class="absolute right-2 top-2 text-gray-400 hover:text-red-500">âœ•</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2 pb-24 custom-scroll">
            <div v-if="displayList.length === 0" class="flex flex-col items-center justify-center mt-20 text-gray-400">
                <div class="text-4xl mb-2">ğŸ“­</div>
                <p>æ‰¾ä¸åˆ°ç¬¦åˆçš„è—¥å“</p>
            </div>

            <div v-for="item in displayList" :key="item.id" class="bg-white rounded-xl shadow-sm mb-3 p-3 border-l-[6px] transition-all duration-300" 
                 :class="isDone(item) ? 'border-green-500 bg-green-50/50' : 'border-red-400'">
                
                <div class="flex justify-between items-start mb-3">
                    <div class="flex-1 mr-2">
                        <div class="font-bold text-gray-900 text-xl leading-tight">{{ item.name }}</div>
                        <div class="text-xs text-gray-500 font-mono mt-1 flex items-center flex-wrap gap-1">
                            {{ item.code }} 
                            <span class="bg-blue-100 text-blue-800 px-1.5 py-0.5 rounded font-bold">{{ item.shelf }}</span>
                        </div>
                        <div class="mt-2 flex flex-wrap gap-1">
                            <span v-if="item.units?.lg?.cap > 0" class="text-[10px] px-2 py-1 bg-blue-100 border border-blue-200 rounded text-blue-700 font-bold">1{{ item.units.lg.name }}={{ item.units.lg.cap }}</span>
                            <span v-if="item.units?.sm?.cap > 1" class="text-[10px] px-2 py-1 bg-green-100 border border-green-200 rounded text-green-700 font-bold">1{{ item.units.sm.name }}={{ item.units.sm.cap }}</span>
                        </div>
                    </div>
                    <div class="text-right min-w-[70px] flex flex-col items-end">
                        <div v-if="isDone(item)" class="text-3xl font-bold text-green-600 leading-none">{{ calcTotal(item) }}</div>
                        <div v-else class="text-lg font-bold text-red-400 animate-pulse bg-red-50 px-2 py-1 rounded">æœªç›¤</div>
                        <button v-if="!isDone(item)" @click="setZero(item)" class="text-xs mt-2 bg-gray-500 text-white px-3 py-1.5 rounded shadow hover:bg-gray-600 btn-act w-full">ğŸ—‘ï¸ ç„¡åº«å­˜</button>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    
                    <div v-if="item.units?.lg?.cap > 0" 
                         class="col-zone col-lg flex flex-col items-center"
                         @click="$event.currentTarget.querySelector('input').focus()">
                         
                        <label class="text-xs text-blue-900 mb-1 font-bold">{{ item.units.lg.name }}</label>
                        <div class="flex w-full items-center gap-1">
                            <button @click.stop="adj(item, 'lg', -1)" class="btn-adj">-</button>
                            <input type="number" inputmode="numeric" pattern="[0-9]*" v-model.number="item.inputs.lg" @input="save(item)" @focus="$event.target.select()" class="input-box" :class="item.inputs.lg!==0?'input-filled':'input-empty'" placeholder="0">
                            <button @click.stop="adj(item, 'lg', 1)" class="btn-adj">+</button>
                        </div>
                    </div>
                    <div v-else class="flex justify-center items-center opacity-10 text-xs bg-gray-50 rounded-lg">-</div>

                    <div v-if="item.units?.sm?.cap > 1" 
                         class="col-zone col-sm flex flex-col items-center"
                         @click="$event.currentTarget.querySelector('input').focus()">

                        <label class="text-xs text-green-900 mb-1 font-bold">{{ item.units.sm.name }}</label>
                        <div class="flex w-full items-center gap-1">
                            <button @click.stop="adj(item, 'sm', -1)" class="btn-adj">-</button>
                            <input type="number" inputmode="numeric" pattern="[0-9]*" v-model.number="item.inputs.sm" @input="save(item)" @focus="$event.target.select()" class="input-box" :class="item.inputs.sm!==0?'input-filled':'input-empty'" placeholder="0">
                            <button @click.stop="adj(item, 'sm', 1)" class="btn-adj">+</button>
                        </div>
                    </div>
                    <div v-else class="flex justify-center items-center opacity-10 text-xs bg-gray-50 rounded-lg">-</div>

                    <div class="col-zone col-lo flex flex-col items-center"
                         @click="$event.currentTarget.querySelector('input').focus()">

                        <label class="text-xs text-orange-900 mb-1 font-bold">é¡†/æ”¯</label>
                        <div class="flex w-full items-center gap-1">
                            <button @click.stop="adj(item, 'lo', -1)" class="btn-adj">-</button>
                            <input type="number" inputmode="numeric" pattern="[0-9]*" v-model.number="item.inputs.lo" @input="save(item)" @focus="$event.target.select()" class="input-box" :class="item.inputs.lo!==0?'input-filled':'input-empty'" placeholder="0">
                            <button @click.stop="adj(item, 'lo', 1)" class="btn-adj">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    window.onerror = function(msg, url, line) {
        const el = document.getElementById('crash-log');
        el.style.display = 'block';
        el.innerHTML += `âŒ ${msg} (Line: ${line})<br>`;
        return false;
    };

    import { createApp, ref, computed, onMounted } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZuNztwb9aLG1RqeDOyrj6KJrPhwBFi9M",
      authDomain: "fyh-pharmacy-inventory.firebaseapp.com",
      databaseURL: "https://fyh-pharmacy-inventory-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fyh-pharmacy-inventory",
      storageBucket: "fyh-pharmacy-inventory.firebasestorage.app",
      messagingSenderId: "751378148626",
      appId: "1:751378148626:web:5a2d2be1c5f905657457cb",
      measurementId: "G-0X63VL8KMR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            const page = ref('home');
            const isOnline = ref(false);
            const isSaving = ref(false);
            const isUploading = ref(false);
            const staffList = ref([]);
            const inventory = ref([]);
            const selUser = ref('');
            const selZone = ref('');
            const keyword = ref('');

            onMounted(() => {
                onValue(dbRef(db, ".info/connected"), s => isOnline.value = s.val());
                onValue(dbRef(db, "staff"), s => staffList.value = s.val() || []);
                onValue(dbRef(db, "inventory"), s => {
                    const data = s.val();
                    if (!data) { inventory.value = []; return; }
                    const arr = Array.isArray(data) ? data : Object.values(data);
                    
                    inventory.value = arr.map(item => {
                        if (!item) return null;
                        if (!item.inputs) item.inputs = { lg: 0, sm: 0, lo: 0 };
                        if (!item.units) item.units = {};
                        
                        let lgN = item.units.lg?.name || 'ç›’';
                        let smN = item.units.sm?.name || 'æ’';
                        // é˜²å‘†ä¿®æ­£ï¼šè‹¥å–®ä½åç¨±ç‚ºæ•¸å­—ï¼Œå¼·åˆ¶è½‰ç‚ºé è¨­
                        if (!isNaN(parseFloat(lgN)) || lgN.length > 5) lgN = 'ç›’';
                        if (!isNaN(parseFloat(smN)) || smN.length > 5) smN = 'æ”¯';

                        if (!item.units.lg) item.units.lg = { cap: 0, name: lgN };
                        else item.units.lg.name = lgN;

                        if (!item.units.sm) item.units.sm = { cap: 0, name: smN };
                        else item.units.sm.name = smN;
                        
                        if (item.done === undefined) item.done = false;
                        if (!item.code) item.code = '???';
                        if (!item.name) item.name = 'æœªçŸ¥è—¥å“';
                        return item;
                    }).filter(x => x !== null);
                });
            });

            const dbCount = computed(() => inventory.value.length);
            const staffCount = computed(() => staffList.value.length);
            const zoneList = computed(() => [...new Set(inventory.value.map(i => i.zone))].sort());
            
            const displayList = computed(() => {
                if (!selZone.value) return [];
                let list = inventory.value.filter(i => i.zone === selZone.value);
                if (keyword.value) {
                    const k = keyword.value.trim().toLowerCase();
                    list = list.filter(i => 
                        (i.name && i.name.toLowerCase().includes(k)) || 
                        (i.code && i.code.toLowerCase().includes(k))
                    );
                }
                return list;
            });

            const currentProgress = computed(() => {
                const list = inventory.value.filter(i => i.zone === selZone.value);
                const total = list.length;
                if (total === 0) return { total: 0, done: 0, pct: 0 };
                const done = list.filter(isDone).length;
                return { total, done, pct: Math.round((done/total)*100) };
            });

            const zoneStats = computed(() => {
                const stats = {};
                zoneList.value.forEach(z => stats[z] = { name: z, total: 0, done: 0 });
                inventory.value.forEach(i => {
                    if (stats[i.zone]) {
                        stats[i.zone].total++;
                        if (isDone(i)) stats[i.zone].done++;
                    }
                });
                return Object.values(stats).map(s => ({
                    ...s, pct: s.total===0 ? 0 : Math.round((s.done/s.total)*100)
                }));
            });

            const isDone = (item) => (item.inputs.lg !== 0 || item.inputs.sm !== 0 || item.inputs.lo !== 0 || item.done);
            
            const calcTotal = (item) => {
                const lg = item.units?.lg?.cap || 0;
                const sm = item.units?.sm?.cap || 0;
                return (item.inputs.lg * lg) + (item.inputs.sm * sm) + item.inputs.lo;
            };

            const startInv = () => { if (selUser.value && selZone.value) page.value = 'work'; };
            const enterAdmin = () => { if (prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼") === "8888") page.value = 'admin'; };
            
            let timerMap = {};
            const save = (item) => {
                isSaving.value = true;
                item.done = true;
                item.user = selUser.value;
                item.time = new Date().toISOString();
                const idx = inventory.value.findIndex(x => x.id === item.id);
                if (idx === -1) return;
                clearTimeout(timerMap[item.id]);
                timerMap[item.id] = setTimeout(() => {
                    update(dbRef(db, `inventory/${idx}`), {
                        inputs: item.inputs,
                        user: item.user,
                        time: item.time,
                        done: true
                    }).then(() => isSaving.value = false).catch(e => console.error(e));
                }, 500);
            };

            const adj = (item, type, val) => {
                item.inputs[type] += val;
                if (item.inputs[type] < 0) item.inputs[type] = 0;
                save(item);
            };

            const setZero = (item) => {
                item.inputs.lg = 0; item.inputs.sm = 0; item.inputs.lo = 0;
                save(item);
            };

            const resetDatabase = () => {
                if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
                    set(dbRef(db, "inventory"), null);
                    set(dbRef(db, "staff"), null);
                    alert("å·²é‡ç½®è³‡æ–™åº«");
                }
            };

            const uploadStaff = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = (evt) => {
                    const txt = evt.target.result.replace(/\r\n/g, ',').replace(/\n/g, ',');
                    const arr = txt.split(',').map(x => x.trim()).filter(x => x);
                    if (arr.length > 0) {
                        set(dbRef(db, "staff"), arr);
                        alert(`å·²åŒ¯å…¥ ${arr.length} ä½äººå“¡`);
                    }
                };
                r.readAsText(f);
            };

            const uploadInventory = async (e) => {
                const files = e.target.files;
                if (!files.length) return;
                isUploading.value = true;
                try {
                    let allItems = [];
                    for (let i=0; i<files.length; i++) {
                        const file = files[i];
                        let zName = file.name.replace(/\.(csv|xlsx|xls)$/, '');
                        const m = zName.match(/[-_]\s*(.+)/); 
                        if (m) zName = m[1].trim();
                        const items = await parseFile(file, zName);
                        allItems = allItems.concat(items);
                    }
                    if (allItems.length > 0) {
                        if (confirm(`æº–å‚™è¦†è“‹ä¸Šå‚³ ${allItems.length} ç­†è—¥å“ï¼Ÿ`)) {
                            const cleanData = JSON.parse(JSON.stringify(allItems));
                            await set(dbRef(db, "inventory"), cleanData);
                            alert("ä¸Šå‚³æˆåŠŸï¼");
                        }
                    } else { alert("è®€å–å¤±æ•—"); }
                } catch(err) { alert("ä¸Šå‚³éŒ¯èª¤: " + err); }
                isUploading.value = false;
            };

            const parseFile = (file, zone) => {
                return new Promise(resolve => {
                    const r = new FileReader();
                    r.onload = (e) => {
                        try {
                            const wb = XLSX.read(e.target.result, { type: 'binary' });
                            const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header:1, defval:'' });
                            let headIdx = -1;
                            for(let r=0; r<Math.min(rows.length, 20); r++) {
                                const str = rows[r].join(' ');
                                if (str.includes('ä»£ç¢¼') || str.includes('Code')) { headIdx = r; break; }
                            }
                            if (headIdx === -1) headIdx = 0;
                            const header = rows[headIdx].map(x => String(x).trim());
                            const idxMap = {
                                code: header.findIndex(x => x.includes('ä»£ç¢¼') || x.includes('Code')),
                                name: header.findIndex(x => x.includes('åç¨±') || x.includes('Name')),
                                shelf: header.findIndex(x => x.includes('å„²ä½') || x.includes('é–€ç‰Œ')),
                                lgCap: header.findIndex(x => x.includes('å¤§åŒ…è£') && x.includes('é‡')),
                                lgUnit: header.findIndex(x => x.includes('å¤§åŒ…è£') && (x.includes('å–®ä½')||x.includes('/'))),
                                smCap: header.findIndex(x => x.includes('å°åŒ…è£') && x.includes('é‡')),
                                smUnit: header.findIndex(x => x.includes('å°åŒ…è£') && (x.includes('å–®ä½')||x.includes('/'))),
                            };
                            if (idxMap.code === -1) {
                                idxMap.code=0; idxMap.name=1; idxMap.shelf=3;
                                idxMap.lgCap=4; idxMap.lgUnit=5;
                                idxMap.smCap=6; idxMap.smUnit=7;
                            }
                            const parsed = [];
                            for(let r=headIdx+1; r<rows.length; r++) {
                                const row = rows[r];
                                const code = row[idxMap.code] ? String(row[idxMap.code]).trim() : '';
                                if (!code) continue;
                                let lgCap = parseInt(row[idxMap.lgCap]) || 0;
                                let lgName = row[idxMap.lgUnit] ? String(row[idxMap.lgUnit]).replace(/[\/x]/g,'').trim() : 'ç›’';
                                let smCap = parseInt(row[idxMap.smCap]) || 1;
                                let smName = row[idxMap.smUnit] ? String(row[idxMap.smUnit]).replace(/[\/x]/g,'').trim() : 'æ’';

                                if (!isNaN(parseFloat(lgName)) || lgName.length > 5) lgName = 'ç›’';
                                if (!isNaN(parseFloat(smName)) || smName.length > 5) smName = 'æ”¯';

                                parsed.push({
                                    id: `${zone}_${code}_${r}`,
                                    code,
                                    name: row[idxMap.name] || 'ç„¡å“å',
                                    shelf: row[idxMap.shelf] || '',
                                    zone,
                                    units: { lg: { cap: lgCap, name: lgName }, sm: { cap: smCap, name: smName } },
                                    inputs: { lg: 0, sm: 0, lo: 0 },
                                    done: false
                                });
                            }
                            resolve(parsed);
                        } catch(err) { resolve([]); }
                    };
                    r.readAsBinaryString(file);
                });
            };

            const exportZone = (z) => {
                const data = inventory.value.filter(x => x.zone === z).map(x => ({
                    'ä»£ç¢¼': x.code, 'åç¨±': x.name, 'å„²ä½': x.shelf,
                    'ç›¤é»é‡': isDone(x) ? `${x.inputs.lg}${x.units?.lg?.name} ${x.inputs.sm}${x.units?.sm?.name} ${x.inputs.lo}é¡†` : 'æœªç›¤',
                    'ç¸½é‡': isDone(x) ? calcTotal(x) : 0, 'ç›¤é»äºº': x.user || '',
                    'æ™‚é–“': x.time ? new Date(x.time).toLocaleString() : ''
                }));
                dlExcel(data, `ç›¤é»_${z}`);
            };

            const exportTotal = () => {
                const map = {};
                inventory.value.forEach(x => {
                    if (!map[x.code]) map[x.code] = { code:x.code, name:x.name, total:0 };
                    if (isDone(x)) {
                        const t = calcTotal(x);
                        map[x.code][x.zone] = t; map[x.code].total += t;
                    }
                });
                dlExcel(Object.values(map), 'å…¨é™¢ç¸½è¡¨');
            };

            const dlExcel = (json, fname) => {
                const ws = XLSX.utils.json_to_sheet(json);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, `${fname}.xlsx`);
            };

            return {
                page, isOnline, isSaving, isUploading,
                selUser, selZone, keyword,
                staffList, dbCount, staffCount, zoneList, displayList, currentProgress, zoneStats,
                startInv, enterAdmin, resetDatabase, uploadStaff, uploadInventory,
                adj, save, setZero, isDone, calcTotal, exportZone, exportTotal
            };
        }
    }).mount('#app');
</script>
</body>
</html>
