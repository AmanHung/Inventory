<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥å±€ç›¤é»ç³»çµ± v3.6 (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; background-color: #f3f4f6; }
        .input-box { @apply w-full h-10 border border-gray-400 rounded mx-1 text-center text-lg font-bold outline-none transition-colors p-0; min-width: 40px; -moz-appearance: textfield; }
        .input-box:focus { @apply ring-2 ring-blue-500 border-blue-500 bg-blue-50; }
        .input-box::-webkit-outer-spin-button, .input-box::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-empty { @apply bg-white text-red-500 placeholder-red-300; }
        .input-filled { @apply bg-blue-50 text-black border-blue-300; }
        .btn-unit { @apply flex-shrink-0 w-10 h-10 flex items-center justify-center bg-gray-200 rounded font-bold text-xl text-gray-600 active:scale-95 select-none cursor-pointer hover:bg-gray-300 shadow-sm border border-gray-300; }
        .btn-zero { @apply mt-auto w-full text-xs bg-gray-600 text-white py-2 rounded shadow hover:bg-gray-700 active:bg-gray-800 active:scale-95 transition font-bold tracking-wide flex items-center justify-center gap-1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="app" class="w-full max-w-md mx-auto min-h-screen bg-white shadow-xl flex flex-col border-x border-gray-200 relative">

    <div v-if="currentPage === 'admin'" class="flex-1 flex flex-col p-6 bg-gray-50 overflow-y-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            <span class="text-blue-600">âš™ï¸</span> è³‡æ–™ç¶­è­·
        </h2>

        <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-pink-500">
            <h3 class="font-bold text-lg mb-2 text-pink-700">0. è£½ä½œé›²ç«¯åŒæ­¥æª”</h3>
            <p class="text-xs text-gray-500 mb-3">
                æ­¥é©Ÿï¼š<br>
                1. åœ¨æ­¤é›»è…¦åŒ¯å…¥æ‰€æœ‰ CSV èˆ‡äººå“¡åå–®ã€‚<br>
                2. é»æ“Šä¸‹æ–¹ä¸‹è¼‰ <b>db.json</b>ã€‚<br>
                3. å°‡è©²æª”æ¡ˆä¸Šå‚³è‡³ GitHub èˆ‡ index.html åŒå±¤ç›®éŒ„ã€‚
            </p>
            <button @click="downloadDB" class="w-full bg-pink-600 text-white font-bold py-3 rounded shadow hover:bg-pink-700 mb-2">
                ğŸ“¥ ä¸‹è¼‰ db.json (åŒæ­¥ç”¨)
            </button>
        </div>

        <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-indigo-500">
            <h3 class="font-bold text-lg mb-2 text-indigo-900">1. äººå“¡åå–®ç®¡ç†</h3>
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-bold text-gray-700">ç›®å‰äººå“¡: {{ staffList.length }} ä½</span>
                <button v-if="staffList.length > 0" @click="clearStaff" class="text-xs text-red-500 underline">æ¸…ç©º</button>
            </div>
            <input type="file" ref="staffInput" accept=".csv,.txt" @change="handleStaffUpload" class="hidden">
            <button @click="$refs.staffInput.click()" class="w-full bg-indigo-100 text-indigo-700 font-bold py-2 rounded border border-indigo-200 hover:bg-indigo-200 transition">
                ğŸ‘¤ åŒ¯å…¥äººå“¡ CSV
            </button>
        </div>

        <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-blue-500">
            <h3 class="font-bold text-lg mb-2 text-blue-900">2. è—¥å“ç›¤é»è¡¨ç®¡ç†</h3>
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-bold text-gray-700">ç›®å‰è—¥å“: {{ inventory.length }} ç­†</span>
                <button v-if="inventory.length > 0" @click="clearInventory" class="text-xs text-red-500 underline">æ¸…ç©º</button>
            </div>
            <input type="file" ref="fileInput" multiple accept=".csv,.xlsx,.xls" @change="handleFileUpload" class="hidden">
            <button @click="$refs.fileInput.click()" class="w-full bg-blue-100 text-blue-700 font-bold py-3 rounded-lg border border-blue-300 hover:bg-blue-200 transition mb-2">
                ğŸ“‚ åŒ¯å…¥ç›¤é»è¡¨ CSV
            </button>
            
            <div v-if="isProcessing" class="flex items-center justify-center gap-3 py-4 text-gray-600">
                <div class="loader"></div> è™•ç†ä¸­...
            </div>

            <div v-if="importSummary.totalFiles > 0" class="mt-4 p-3 bg-green-50 border border-green-200 rounded text-sm text-green-800">
                <p>âœ… è®€å–æª”æ¡ˆ: <strong>{{ importSummary.totalFiles }}</strong> å€‹</p>
                <p>ğŸ’Š è—¥å“ç¸½æ•¸: <strong>{{ importSummary.totalItems }}</strong> ç­†</p>
                <button @click="confirmImport" class="mt-3 w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 shadow">
                    ç¢ºèªæ›´æ–°è³‡æ–™åº«
                </button>
            </div>
        </div>
        <button @click="currentPage = 'login'" class="mt-auto w-full bg-gray-600 text-white font-bold py-3 rounded-lg shadow hover:bg-gray-700">è¿”å›é¦–é </button>
    </div>

    <div v-else-if="currentPage === 'report'" class="flex-1 flex flex-col p-6 bg-gray-50 overflow-y-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            <span class="text-green-600">ğŸ“Š</span> å ±è¡¨ä¸­å¿ƒ
        </h2>

        <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-blue-600">
            <h3 class="font-bold text-lg mb-3 flex justify-between items-center">
                å„å€é€²åº¦èˆ‡åŒ¯å‡º
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">å…± {{ uniqueZones.length }} å€</span>
            </h3>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 custom-scroll">
                <div v-for="z in zoneProgress" :key="z.name" class="w-full bg-gray-50 p-3 rounded border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-800 text-sm">{{ z.name }}</span>
                            <span class="text-xs font-mono" :class="{'text-green-600 font-bold': z.percent === 100, 'text-gray-500': z.percent < 100}">
                                {{ z.done }}/{{ z.total }} ({{ z.percent }}%)
                            </span>
                        </div>
                        <button @click="exportZone(z.name)" 
                            class="text-xs font-bold px-3 py-1.5 rounded transition-colors shadow-sm border flex items-center gap-1"
                            :class="z.percent === 100 ? 'bg-green-100 text-green-800 border-green-300 hover:bg-green-200' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100'">
                            <span v-if="z.percent === 100">âœ…</span><span v-else>ğŸ“¥</span> åŒ¯å‡º
                        </button>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all duration-500" :class="{ 'bg-red-500': z.percent < 50, 'bg-yellow-400': z.percent >= 50 && z.percent < 100, 'bg-green-500': z.percent === 100 }" :style="{ width: z.percent + '%' }"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-purple-500">
            <h3 class="font-bold text-lg mb-2">åº«å­˜ç¸½è¡¨</h3>
            <p class="text-xs text-gray-500 mb-3">è—¥å x å€åŸŸ äº¤å‰åˆ†æã€‚</p>
            <button @click="exportMasterPivotReport" class="w-full bg-purple-600 text-white font-bold py-2 rounded hover:bg-purple-700 shadow">åŒ¯å‡ºå…¨é™¢ç¸½è¡¨</button>
        </div>
        <button @click="currentPage = 'login'" class="mt-auto w-full bg-gray-600 text-white font-bold py-3 rounded-lg shadow hover:bg-gray-700">è¿”å›é¦–é </button>
    </div>

    <div v-else-if="currentPage === 'login'" class="flex-1 flex flex-col justify-center items-center p-8 bg-blue-50">
        <div class="w-full max-w-sm relative">
            
            <button @click="fetchCloudDB(true)" class="absolute -top-10 right-0 text-xs bg-white text-blue-600 border border-blue-200 px-3 py-1 rounded-full shadow hover:bg-blue-50 flex items-center gap-1">
                <span v-if="isLoadingCloud" class="animate-spin">â†»</span> 
                <span v-else>â˜ï¸</span> 
                é‡æ–°åŒæ­¥è³‡æ–™
            </button>

            <h1 class="text-3xl font-bold text-blue-800 text-center mb-1">è—¥å±€ç›¤é»ç³»çµ±</h1>
            <p class="text-center text-gray-400 text-sm mb-8">v3.6 (é›²ç«¯åŒæ­¥ç‰ˆ)</p>
            
            <div v-if="inventory.length === 0" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded shadow-sm">
                <p class="font-bold">âš ï¸ å°šç„¡è—¥å“è³‡æ–™</p>
                <p class="text-sm mt-1">ç³»çµ±æ­£åœ¨å˜—è©¦è®€å– <b>db.json</b>...<br>å¦‚æœé•·æ™‚é–“æœªé¡¯ç¤ºï¼Œè«‹ç¢ºèª GitHub æ˜¯å¦æœ‰ä¸Šå‚³è©²æª”æ¡ˆã€‚</p>
                <button @click="enterAdmin" class="mt-2 text-yellow-800 underline text-xs">æ‰‹å‹•åŒ¯å…¥</button>
            </div>
            
            <div v-if="inventory.length > 0 && staffList.length === 0" class="bg-indigo-100 border-l-4 border-indigo-500 text-indigo-700 p-4 mb-6 rounded shadow-sm">
                <p class="font-bold">âš ï¸ å°šç„¡äººå“¡åå–®</p>
                <p class="text-sm">è«‹ç¢ºèª db.json æ˜¯å¦åŒ…å«äººå“¡è³‡æ–™ã€‚</p>
            </div>

            <div v-if="inventory.length > 0 && staffList.length > 0">
                <label class="block text-gray-700 text-sm font-bold mb-2">1. ç›¤é»äººå“¡</label>
                <select v-model="currentUser" class="w-full p-3 border rounded-lg bg-white shadow-sm text-lg mb-4 cursor-pointer hover:border-blue-500">
                    <option disabled value="">-- è«‹é¸æ“‡ --</option>
                    <option v-for="name in staffList" :value="name">{{ name }}</option>
                </select>

                <label class="block text-gray-700 text-sm font-bold mb-2">2. ç›¤é»å€åŸŸ</label>
                <select v-model="currentZone" class="w-full p-3 border rounded-lg bg-white shadow-sm text-lg mb-6 cursor-pointer hover:border-blue-500">
                    <option disabled value="">-- è«‹é¸æ“‡ --</option>
                    <option v-for="zone in uniqueZones" :value="zone">{{ zone }}</option>
                </select>

                <button @click="enterSystem" 
                    :disabled="!currentUser || !currentZone"
                    :class="{'opacity-50 cursor-not-allowed': !currentUser || !currentZone}"
                    class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow hover:bg-blue-700 transition text-lg mb-6">
                    é–‹å§‹ç›¤é»
                </button>

                <hr class="border-gray-300 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <button @click="currentPage = 'report'" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 rounded shadow hover:bg-gray-50 flex flex-col items-center">
                        <span class="text-2xl mb-1">ğŸ“Š</span> å ±è¡¨ä¸­å¿ƒ
                    </button>
                    <button @click="enterAdmin" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 rounded shadow hover:bg-gray-50 flex flex-col items-center">
                        <span class="text-2xl mb-1">âš™ï¸</span> è³‡æ–™ç¶­è­·
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div v-else class="flex-1 flex flex-col h-screen overflow-hidden">
        <div class="bg-blue-700 p-3 text-white shadow-md z-20 shrink-0">
            <div class="flex justify-between items-center mb-2">
                <div class="flex flex-col overflow-hidden">
                    <span class="font-bold text-lg truncate">{{ currentUser }}</span>
                    <span class="text-xs text-blue-200 truncate">å€åŸŸ: {{ currentZone }}</span>
                </div>
                <button @click="exitCounting" class="text-xs font-bold px-3 py-2 rounded bg-blue-800 border border-blue-500 hover:bg-blue-600 transition shadow flex items-center gap-1">
                    ğŸ’¾ å„²å­˜é›¢é–‹
                </button>
            </div>
            
            <div class="flex justify-between items-end text-xs text-blue-100 mb-1 px-1">
                <span class="font-bold">ç›¤é»é€²åº¦</span>
                <span class="font-mono">{{ currentZoneStats.done }}/{{ currentZoneStats.total }} ({{ currentZoneStats.percent }}%)</span>
            </div>
            <div class="w-full bg-blue-900 rounded-full h-2.5 mb-3 overflow-hidden border border-blue-600">
                <div class="bg-green-400 h-2.5 rounded-full transition-all duration-500" :style="{ width: progressPercent + '%' }"></div>
            </div>
            <div class="relative">
                <input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹è—¥åã€ä»£ç¢¼..." class="w-full px-3 py-2 rounded text-gray-800 outline-none shadow-inner focus:ring-2 focus:ring-blue-400">
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2 bg-gray-100 pb-20 no-scrollbar">
            <div v-for="item in filteredInventory" :key="item.id" 
                 class="rounded-lg shadow mb-3 p-3 border-l-[6px] border transition-all duration-200 bg-white"
                 :class="isItemComplete(item) ? 'border-green-500 border-l-green-600 bg-green-50/30' : 'border-red-300 border-l-red-500 bg-red-50/30'">
                
                <div class="flex justify-between items-start mb-3 gap-2">
                    <div class="flex-1 min-w-0"> 
                        <div class="font-bold text-lg text-gray-800 leading-tight break-words">{{ item.name }}</div>
                        <div class="text-xs text-gray-500 font-mono mt-1 font-bold flex flex-wrap items-center gap-2">
                            {{ item.code }} 
                            <span class="text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded text-[10px]">{{ item.shelf }}</span>
                        </div>
                        <div class="mt-2 flex flex-wrap gap-1">
                            <span v-if="item.units.large.cap > 0" class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-600 border border-gray-200">1{{ item.units.large.name }}={{ item.units.large.cap }}</span>
                            <span v-if="item.units.small.cap > 1" class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-600 border border-gray-200">1{{ item.units.small.name }}={{ item.units.small.cap }}</span>
                        </div>
                    </div>
                    
                    <div class="flex-shrink-0 text-right flex flex-col justify-between h-full min-h-[80px]">
                        <div>
                            <div v-if="isItemComplete(item)" class="text-3xl font-bold text-green-600 leading-none tracking-tight">{{ calculateTotal(item) }}</div>
                            <div v-else class="text-lg font-bold text-red-500 animate-pulse leading-none">æœªç›¤</div>
                            <div class="text-[10px] text-gray-400 mt-1">ç¸½é¡†æ•¸</div>
                        </div>
                        <button v-if="!isItemComplete(item)" @click="setAllZero(item)" class="btn-zero"><span class="text-lg">ğŸ—‘ï¸</span> ç„¡åº«å­˜</button>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-1 rounded p-2 border bg-opacity-50" :class="isItemComplete(item) ? 'bg-gray-50 border-gray-200' : 'bg-white border-red-100'">
                    <div class="text-center flex flex-col" v-if="item.units.large.cap > 0">
                        <label class="text-[11px] text-gray-600 block mb-1 font-bold truncate">{{ item.units.large.name }}</label>
                        <div class="flex items-center justify-center w-full gap-0.5">
                            <button class="btn-unit" @click="updateQty(item, 'large', -1)">-</button>
                            <input type="number" v-model.number="item.inputs.large" @input="markUpdated(item)" :class="item.inputs.large === null ? 'input-empty' : 'input-filled'" class="input-box" placeholder="?">
                            <button class="btn-unit" @click="updateQty(item, 'large', 1)">+</button>
                        </div>
                    </div>
                    <div v-else class="flex flex-col justify-center items-center opacity-20"><span class="text-xs">-</span></div>

                    <div class="text-center flex flex-col" v-if="item.units.small.cap > 1">
                        <label class="text-[11px] text-gray-600 block mb-1 font-bold truncate">{{ item.units.small.name }}</label>
                        <div class="flex items-center justify-center w-full gap-0.5">
                            <button class="btn-unit" @click="updateQty(item, 'small', -1)">-</button>
                            <input type="number" v-model.number="item.inputs.small" @input="markUpdated(item)" :class="item.inputs.small === null ? 'input-empty' : 'input-filled'" class="input-box" placeholder="?">
                            <button class="btn-unit" @click="updateQty(item, 'small', 1)">+</button>
                        </div>
                    </div>
                    <div v-else class="flex flex-col justify-center items-center opacity-20"><span class="text-xs">-</span></div>

                    <div class="text-center flex flex-col">
                        <label class="text-[11px] text-gray-600 block mb-1 font-bold truncate">é¡†/æ”¯</label>
                        <div class="flex items-center justify-center w-full gap-0.5">
                            <button class="btn-unit" @click="updateQty(item, 'loose', -1)">-</button>
                            <input type="number" v-model.number="item.inputs.loose" @input="markUpdated(item)" :class="item.inputs.loose === null ? 'input-empty' : 'input-filled'" class="input-box" placeholder="?">
                            <button class="btn-unit" @click="updateQty(item, 'loose', 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="filteredInventory.length === 0" class="text-center text-gray-400 mt-10 py-10">
                <div class="text-4xl mb-2">ğŸ”</div>
                {{ inventory.length === 0 ? 'è«‹å…ˆåŒ¯å…¥è³‡æ–™' : 'è©²å€åŸŸç„¡æ­¤è—¥å“' }}
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
    setup() {
        const currentPage = ref('login');
        const currentUser = ref('');
        const currentZone = ref('');
        const searchQuery = ref('');
        const staffList = ref([]);
        const inventory = ref([]);
        
        const isProcessing = ref(false);
        const isLoadingCloud = ref(false); // é›²ç«¯è®€å–ç‹€æ…‹
        const importSummary = ref({ totalFiles: 0, totalItems: 0 });
        const tempImportData = ref([]);
        const exportTargetZone = ref('');

        onMounted(() => {
            // å˜—è©¦å¾ LocalStorage è®€å–
            const savedStaff = localStorage.getItem('pharmacy_staff_list_v3');
            if (savedStaff) try { staffList.value = JSON.parse(savedStaff); } catch(e) {}
            
            const savedData = localStorage.getItem('pharmacy_inventory_v3');
            if (savedData) {
                try { inventory.value = JSON.parse(savedData); } catch (e) {}
            }

            // å¦‚æœæœ¬åœ°å®Œå…¨æ²’è³‡æ–™ï¼Œæˆ–ä½¿ç”¨è€…æƒ³å¼·åˆ¶æ›´æ–°ï¼ŒåŸ·è¡Œ fetchCloudDB
            if (inventory.value.length === 0) {
                fetchCloudDB(false); // è‡ªå‹•éœé»˜å˜—è©¦
            }
        });

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šè®€å– GitHub ä¸Šçš„ db.json ---
        const fetchCloudDB = async (manual = false) => {
            isLoadingCloud.value = true;
            try {
                // è®€å–ç›¸å°è·¯å¾‘çš„ db.json (éœ€è¦ä½ ä¸Šå‚³åˆ° GitHub)
                // åŠ ä¸Š timestamp é¿å…å¿«å–
                const response = await fetch(`./db.json?t=${new Date().getTime()}`);
                
                if (!response.ok) {
                    if (manual) alert("æ‰¾ä¸åˆ°é›²ç«¯è³‡æ–™åº« (db.json)ã€‚\nè«‹ç¢ºèªæ˜¯å¦å·²ä¸Šå‚³è‡³ GitHubã€‚");
                    return;
                }

                const cloudData = await response.json();
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æ•ˆ
                if (cloudData.inventory && Array.isArray(cloudData.inventory)) {
                    // å¦‚æœæ˜¯æ‰‹å‹•æŒ‰æ›´æ–°ï¼Œæˆ–æ˜¯æœ¬åœ°æ²’è³‡æ–™ï¼Œå°±è¼‰å…¥
                    if (manual) {
                        if(!confirm("ç¢ºå®šè¦å¾é›²ç«¯é‡æ–°è¼‰å…¥è³‡æ–™å—ï¼Ÿ\né€™æœƒè¦†è“‹ç›®å‰çš„ç›¤é»æ¸…å–®çµæ§‹ï¼Œä½†æœƒå˜—è©¦ä¿ç•™å·²ç›¤é»çš„æ•¸å­—ã€‚")) {
                            isLoadingCloud.value = false;
                            return;
                        }
                    }

                    // åˆä½µé‚è¼¯ï¼šä¿ç•™æœ¬åœ°çš„ã€Œå·²ç›¤é»æ•¸æ“šã€
                    const oldDataMap = {};
                    inventory.value.forEach(item => {
                        if (isItemComplete(item) || item.inputs.large !== null) oldDataMap[item.id] = item;
                    });

                    inventory.value = cloudData.inventory.map(newItem => {
                        if (oldDataMap[newItem.id]) {
                            newItem.inputs = oldDataMap[newItem.id].inputs;
                            newItem.user = oldDataMap[newItem.id].user;
                            newItem.timestamp = oldDataMap[newItem.id].timestamp;
                        }
                        return newItem;
                    });

                    if (cloudData.staff) {
                        staffList.value = cloudData.staff;
                        localStorage.setItem('pharmacy_staff_list_v3', JSON.stringify(staffList.value));
                    }
                    
                    saveToLocal();
                    if(manual) alert("è³‡æ–™åŒæ­¥å®Œæˆï¼");
                }
            } catch (e) {
                console.error(e);
                if (manual) alert("è®€å–éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æª”æ¡ˆæ ¼å¼ã€‚");
            } finally {
                isLoadingCloud.value = false;
            }
        };

        // --- æ–°å¢ï¼šåŒ¯å‡º db.json (çµ¦ç®¡ç†å“¡ä¸Šå‚³ç”¨) ---
        const downloadDB = () => {
            const data = {
                staff: staffList.value,
                inventory: inventory.value.map(item => ({
                    ...item,
                    inputs: { large: null, small: null, loose: null }, // æ¸…ç©ºç›¤é»æ•¸æ“šï¼Œåªç•™çµæ§‹
                    user: null,
                    timestamp: null
                }))
            };
            const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "db.json";
            a.click();
            URL.revokeObjectURL(url);
        };

        // --- ç®¡ç†å“¡å¯†ç¢¼ ---
        const enterAdmin = () => {
            const password = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
            if (password === "8888") currentPage.value = 'admin'; // é è¨­å¯†ç¢¼ 8888
            else if (password !== null) alert("å¯†ç¢¼éŒ¯èª¤ï¼");
        };

        // --- äººå“¡åŒ¯å…¥ ---
        const handleStaffUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                let raw = e.target.result.replace(/äººå“¡åå–®/g, '').replace(/\r\n/g, ',').replace(/\n/g, ',');
                const names = raw.split(',').map(s => s.trim()).filter(s => s.length > 0);
                if (names.length > 0 && confirm(`åŒ¯å…¥ ${names.length} ä½äººå“¡ï¼Ÿ`)) {
                    staffList.value = names;
                    localStorage.setItem('pharmacy_staff_list_v3', JSON.stringify(names));
                    alert('äººå“¡åå–®æ›´æ–°æˆåŠŸï¼');
                }
            };
            reader.readAsText(file);
        };
        const clearStaff = () => { if(confirm('ç¢ºå®šæ¸…ç©ºäººå“¡ï¼Ÿ')) { staffList.value=[]; localStorage.removeItem('pharmacy_staff_list_v3'); } };

        // --- è—¥å“åŒ¯å…¥ ---
        const handleFileUpload = async (event) => {
            const files = event.target.files;
            if (!files.length) return;
            isProcessing.value = true;
            tempImportData.value = [];
            importSummary.value = { totalFiles: 0, totalItems: 0 };
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                let zoneName = file.name.replace('.csv','').replace('.xlsx','').replace('.xls','');
                const match = zoneName.match(/-\s*(.+)/); 
                if (match && match[1]) zoneName = match[1].trim();
                try {
                    const data = await parseSingleFile(file, zoneName);
                    tempImportData.value = [...tempImportData.value, ...data];
                    importSummary.value.totalFiles++;
                } catch(e) {}
            }
            importSummary.value.totalItems = tempImportData.value.length;
            isProcessing.value = false;
        };

        const parseSingleFile = (file, zoneName) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '' });
                    resolve(processRows(rows, zoneName));
                };
                reader.readAsArrayBuffer(file);
            });
        };

        const processRows = (rows, zoneName) => {
            if (!rows || rows.length === 0) return [];
            let headerIdx = -1, colMap = {};
            for (let i = 0; i < Math.min(rows.length, 20); i++) {
                const rowStr = rows[i].map(c => String(c).trim());
                if (rowStr.includes('ä»£ç¢¼') && (rowStr.includes('åç¨±') || rowStr.includes('è—¥å“åç¨±'))) {
                    headerIdx = i;
                    rows[i].forEach((col, idx) => {
                        const c = String(col).trim();
                        if (c.includes('ä»£ç¢¼')) colMap.code = idx;
                        else if (c.includes('åç¨±')) colMap.name = idx;
                        else if (c.includes('é–€ç‰Œ') || c.includes('å„²ä½')) colMap.shelf = idx;
                        else if (c.includes('å¤§åŒ…è£') && c.includes('é‡')) colMap.lgCap = idx;
                        else if (c.includes('å¤§åŒ…è£') && (c.includes('å–®ä½') || c.includes('/'))) colMap.lgUnit = idx;
                        else if (c.includes('å°åŒ…è£') && c.includes('é‡')) colMap.smCap = idx;
                        else if (c.includes('å°åŒ…è£') && (c.includes('å–®ä½') || c.includes('/'))) colMap.smUnit = idx;
                    });
                    break;
                }
            }
            if (headerIdx === -1) return [];
            const items = [];
            for (let i = headerIdx + 1; i < rows.length; i++) {
                const row = rows[i];
                const code = row[colMap.code];
                const name = row[colMap.name];
                if (!code || !name) continue;
                let lgCap = 0, lgUnit = 'ç›’';
                if (colMap.lgCap !== undefined) {
                    const val = parseInt(row[colMap.lgCap]);
                    if (!isNaN(val)) lgCap = val;
                    if (row[colMap.lgCap+1] && String(row[colMap.lgCap+1]).includes('/')) lgUnit = String(row[colMap.lgCap+1]).replace('/','').replace('x','').trim();
                }
                let smCap = 1, smUnit = 'æ’';
                if (colMap.smCap !== undefined) {
                    const val = parseInt(row[colMap.smCap]);
                    if (!isNaN(val)) smCap = val;
                    if (row[colMap.smCap+1] && String(row[colMap.smCap+1]).includes('/')) smUnit = String(row[colMap.smCap+1]).replace('/','').replace('x','').trim();
                }
                items.push({
                    id: `${code}_${zoneName}_${i}`,
                    code: String(code).trim(),
                    name: String(name).trim(),
                    shelf: colMap.shelf !== undefined ? String(row[colMap.shelf]).trim() : '',
                    zone: zoneName,
                    units: { large: { name: lgUnit, cap: lgCap }, small: { name: smUnit, cap: smCap }, loose: { name: 'é¡†', cap: 1 } },
                    inputs: { large: null, small: null, loose: null },
                    timestamp: null, user: null
                });
            }
            return items;
        };

        const confirmImport = () => {
            if (confirm(`åŒ¯å…¥ ${importSummary.value.totalItems} ç­†ï¼Ÿ`)) {
                const oldDataMap = {};
                inventory.value.forEach(item => { if (isItemComplete(item) || item.inputs.large !== null) oldDataMap[item.id] = item; });
                inventory.value = tempImportData.value.map(newItem => {
                    if (oldDataMap[newItem.id]) {
                        newItem.inputs = oldDataMap[newItem.id].inputs;
                        newItem.user = oldDataMap[newItem.id].user;
                        newItem.timestamp = oldDataMap[newItem.id].timestamp;
                    }
                    return newItem;
                });
                saveToLocal();
                alert('åŒ¯å…¥æˆåŠŸï¼');
                tempImportData.value = [];
                importSummary.value = { totalFiles: 0, totalItems: 0 };
            }
        };
        const clearInventory = () => { if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')) { inventory.value=[]; localStorage.removeItem('pharmacy_inventory_v3'); } };

        // --- æ¥­å‹™é‚è¼¯ ---
        const enterSystem = () => currentPage.value = 'inventory';
        const exitCounting = () => { saveToLocal(); currentPage.value = 'login'; };
        const uniqueZones = computed(() => Array.from(new Set(inventory.value.map(i => i.zone))).sort());
        const isItemComplete = (item) => {
            const l = item.units.large.cap > 0 ? item.inputs.large !== null : true;
            const s = item.units.small.cap > 1 ? item.inputs.small !== null : true;
            const loose = item.inputs.loose !== null;
            return l && s && loose;
        };
        const calculateTotal = (item) => {
            if (!isItemComplete(item)) return 0;
            return (item.inputs.large || 0) * item.units.large.cap + (item.inputs.small || 0) * item.units.small.cap + (item.inputs.loose || 0);
        };
        const setAllZero = (item) => {
            if(item.units.large.cap > 0) item.inputs.large = 0;
            if(item.units.small.cap > 1) item.inputs.small = 0;
            item.inputs.loose = 0;
            markUpdated(item);
        };
        const updateQty = (item, type, amount) => {
            if (item.inputs[type] === null) item.inputs[type] = 0;
            item.inputs[type] += amount;
            if (item.inputs[type] < 0) item.inputs[type] = 0;
            markUpdated(item);
        };
        const markUpdated = (item) => {
            item.user = currentUser.value;
            item.timestamp = new Date().toISOString();
            saveToLocal();
        };
        const saveToLocal = () => {
            localStorage.setItem('pharmacy_inventory_v3', JSON.stringify(inventory.value));
        };

        const filteredInventory = computed(() => {
            let list = inventory.value.filter(i => i.zone === currentZone.value);
            if (searchQuery.value) {
                const q = searchQuery.value.toLowerCase();
                list = list.filter(i => i.name.toLowerCase().includes(q) || i.code.toLowerCase().includes(q));
            }
            return list;
        });
        const uncountedCount = computed(() => filteredInventory.value.filter(i => !isItemComplete(i)).length);
        const progressPercent = computed(() => {
            const total = filteredInventory.value.length;
            return total === 0 ? 0 : ((total - uncountedCount.value) / total) * 100;
        });
        
        const currentZoneStats = computed(() => {
            const total = filteredInventory.value.length;
            const done = total - uncountedCount.value;
            const percent = total === 0 ? 0 : Math.round((done / total) * 100);
            return { total, done, percent };
        });

        const zoneProgress = computed(() => {
            const stats = {};
            uniqueZones.value.forEach(z => stats[z] = { total: 0, done: 0 });
            inventory.value.forEach(item => {
                if (stats[item.zone]) {
                    stats[item.zone].total++;
                    if (isItemComplete(item)) stats[item.zone].done++;
                }
            });
            return Object.keys(stats).map(zone => ({
                name: zone,
                total: stats[zone].total,
                done: stats[zone].done,
                percent: stats[zone].total === 0 ? 0 : Math.round((stats[zone].done / stats[zone].total) * 100)
            }));
        });

        const exportZone = (zoneName) => {
            const targetItems = inventory.value.filter(i => i.zone === zoneName);
            const exportData = targetItems.map(item => {
                const finished = isItemComplete(item);
                let details = [];
                if (item.units.large.cap > 0 && item.inputs.large !== null) details.push(`${item.inputs.large
