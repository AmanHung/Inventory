<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥å±€ç›¤é»ç³»çµ± v5.25 (RWDå„ªåŒ–ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/shim.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* UI åŸºç¤è¨­å®š */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f3f4f6; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
        }
        
        .btn-act { transition: transform 0.1s; }
        .btn-act:active { transform: scale(0.95); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .dot-green { background: #22c55e; box-shadow: 0 0 4px #22c55e; }
        .dot-red { background: #ef4444; }
        
        /* æ»¾å‹•æ¢å„ªåŒ– */
        .custom-scroll { -webkit-overflow-scrolling: touch; }
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* æ‹–æ›³æ²å‹• */
        .drag-scroll { cursor: grab; overflow-x: auto; scrollbar-width: thin; }
        .drag-scroll:active { cursor: grabbing; }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
        .editable:hover { opacity: 0.8; transform: scale(1.05); transition: all 0.2s; }
    </style>
</head>
<body>

<div id="crash-log" style="display:none; position:fixed; bottom:0; left:0; right:0; background:#7f1d1d; color:#fff; padding:10px; font-size:12px; z-index:9999; max-height:150px; overflow:auto;"></div>

<div id="app" class="w-full h-[100dvh] bg-gray-100 flex flex-col md:flex-row relative overflow-hidden">

    <div class="hidden md:flex flex-col w-64 bg-blue-800 text-white shadow-xl z-20 shrink-0">
        <div class="p-6">
            <h1 class="text-2xl font-extrabold tracking-wider">è—¥å±€ç›¤é»</h1>
            <p class="text-xs text-blue-300 mt-1">V5.25 Desktop</p>
        </div>
        
        <nav class="flex-1 px-4 space-y-2">
            <button @click="page='home'" :class="page==='home'?'bg-blue-700':''" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition flex items-center gap-3">
                <span>ğŸ </span> é¦–é  / ç™»å…¥
            </button>
            <button @click="startInvCheck" :class="page==='work'?'bg-blue-700':''" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition flex items-center gap-3">
                <span>ğŸ“</span> ç›¤é»ä½œæ¥­
            </button>
            <button @click="page='report'" :class="page==='report'?'bg-blue-700':''" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition flex items-center gap-3">
                <span>ğŸ“Š</span> å ±è¡¨ä¸­å¿ƒ
            </button>
            <button @click="enterAdmin" :class="page==='admin'?'bg-blue-700':''" class="w-full text-left px-4 py-3 rounded-lg hover:bg-blue-700 transition flex items-center gap-3">
                <span>âš™ï¸</span> ç³»çµ±ç¶­è­·
            </button>
        </nav>

        <div class="p-4 border-t border-blue-700">
            <div class="flex items-center gap-2 text-sm text-blue-200">
                <span class="dot" :class="isOnline ? 'dot-green' : 'dot-red'"></span>
                {{ isOnline ? 'é€£ç·šæ­£å¸¸' : 'æ–·ç·š' }}
            </div>
            <div class="mt-2 text-xs text-blue-400">User: {{ selUser || 'æœªç™»å…¥' }}</div>
        </div>
    </div>

    <div class="flex-1 flex flex-col h-full overflow-hidden relative">

        <div class="md:hidden absolute top-3 right-3 z-50 flex items-center gap-2 pointer-events-none">
            </div>

        <div v-if="page === 'admin'" class="flex-1 p-4 md:p-8 bg-gray-50 overflow-y-auto custom-scroll">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-2">âš™ï¸ ç³»çµ±ç¶­è­·</h2>
                    <button @click="page='home'" class="md:hidden text-sm bg-gray-200 px-3 py-1 rounded">å›é¦–é </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-red-50 p-6 rounded-xl border border-red-200 md:col-span-2">
                        <h3 class="font-bold text-xl text-red-800 mb-2">âš ï¸ è³‡æ–™åº«é‡ç½®</h3>
                        <div class="text-sm text-red-600 mb-4">è‹¥è³‡æ–™çµæ§‹ç•°å¸¸æˆ–éœ€è¦é‡æ–°é–‹å§‹æ–°ä¸€è¼ªç›¤é»ï¼Œè«‹åŸ·è¡Œæ­¤æ“ä½œã€‚</div>
                        <button @click="resetDatabase" class="bg-red-600 text-white font-bold px-6 py-3 rounded-lg shadow hover:bg-red-700 btn-act">ğŸ”¥ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-lg text-gray-700 mb-4">1. äººå“¡åå–®</h3>
                        <input type="file" ref="fileStaff" accept=".csv,.txt" class="hidden" @change="uploadStaff">
                        <button @click="$refs.fileStaff.click()" class="w-full py-8 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-blue-500 hover:text-blue-500 transition btn-act flex flex-col items-center justify-center gap-2">
                            <span class="text-3xl">ğŸ‘¤</span>
                            <span>é»æ“ŠåŒ¯å…¥äººå“¡ CSV</span>
                        </button>
                        <div v-if="staffCount > 0" class="text-sm text-green-600 mt-3 text-center font-bold">âœ… ç›®å‰æœ‰ {{ staffCount }} ä½äººå“¡</div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h3 class="font-bold text-lg text-gray-700 mb-4">2. ç›¤é»è¡¨</h3>
                        <input type="file" ref="fileInv" multiple accept=".csv,.xlsx,.xls" class="hidden" @change="uploadInventory">
                        <button @click="$refs.fileInv.click()" class="w-full py-8 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-blue-500 hover:text-blue-500 transition btn-act flex flex-col items-center justify-center gap-2">
                            <span class="text-3xl">ğŸ“‚</span>
                            <span>é»æ“ŠåŒ¯å…¥ç›¤é»è¡¨ (å¤šæª”)</span>
                        </button>
                        <div v-if="isUploading" class="mt-3 text-center text-blue-600 flex justify-center items-center gap-2"><div class="loader"></div> è™•ç†ä¸­...</div>
                        <div v-if="dbCount > 0" class="text-sm text-green-600 mt-3 text-center font-bold">âœ… é›²ç«¯å·²æœ‰ {{ dbCount }} ç­†è—¥å“</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-else-if="page === 'report'" class="flex-1 p-4 md:p-8 bg-gray-50 overflow-y-auto custom-scroll">
            <div class="max-w-5xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-2">ğŸ“Š å ±è¡¨ä¸­å¿ƒ</h2>
                    <button @click="page='home'" class="md:hidden text-sm bg-gray-200 px-3 py-1 rounded">å›é¦–é </button>
                </div>

                <div class="flex justify-end mb-4">
                    <button @click="exportTotal" class="bg-purple-600 text-white font-bold px-6 py-3 rounded-xl shadow hover:bg-purple-700 btn-act flex items-center gap-2">
                        <span>ğŸ“‘</span> åŒ¯å‡ºå…¨é™¢ç¸½è¡¨
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="z in zoneStats" :key="z.name" class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 hover:shadow-md transition">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <div class="font-bold text-lg text-gray-800 mb-1">{{ z.name }}</div>
                                <div class="flex gap-1">
                                    <span v-if="z.hasManual" class="text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded">è£œå–®</span>
                                    <span v-if="z.hasModified" class="text-[10px] bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded">ç•°å‹•</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold" :class="z.pct===100?'text-green-600':'text-blue-600'">{{ z.pct }}%</div>
                                <div class="text-xs text-gray-400">{{ z.done }}/{{ z.total }}</div>
                            </div>
                        </div>
                        
                        <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden mb-4">
                            <div class="h-full transition-all duration-500" :class="z.pct===100?'bg-green-500':(z.pct>50?'bg-yellow-400':'bg-red-500')" :style="{width: z.pct+'%'}"></div>
                        </div>

                        <button @click="exportZone(z.name)" class="w-full py-2 rounded-lg border transition btn-act font-bold text-sm" 
                                :class="z.pct===100 ? 'bg-green-50 text-green-700 border-green-200 hover:bg-green-100' : 'bg-gray-50 text-gray-600 border-gray-200 hover:bg-gray-100'">
                            {{ z.pct===100 ? 'âœ… ä¸‹è¼‰å®Œæˆå ±è¡¨' : 'ğŸ“¥ ä¸‹è¼‰ç›®å‰é€²åº¦' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div v-else-if="page === 'home'" class="flex-1 flex flex-col justify-center items-center p-8 bg-blue-50 overflow-y-auto custom-scroll">
            <div class="w-full max-w-sm bg-white/50 backdrop-blur-sm p-8 rounded-3xl shadow-xl border border-white">
                <h1 class="text-4xl font-extrabold text-blue-900 text-center mb-2">è—¥å±€ç›¤é»ç³»çµ±</h1>
                <p class="text-center text-gray-400 text-xs mb-8 tracking-widest">FIREBASE V5.25 RWD</p>

                <div v-if="!isOnline" class="bg-red-100 text-red-700 p-3 rounded-xl mb-6 text-center text-sm font-bold flex items-center justify-center gap-2">
                    <span class="dot dot-red"></span> é€£ç·šä¸­æ–·
                </div>

                <div v-if="dbCount === 0" class="bg-yellow-50 border border-yellow-200 p-6 rounded-xl text-center mb-6">
                    <p class="text-yellow-800 font-bold text-lg mb-2">å°šæœªå»ºç«‹è³‡æ–™åº«</p>
                    <button @click="enterAdmin" class="text-sm bg-yellow-200 px-4 py-2 rounded text-yellow-800 hover:bg-yellow-300 btn-act">å‰å¾€å¾Œå°åŒ¯å…¥</button>
                </div>

                <div v-else>
                    <label class="block text-gray-700 text-sm font-bold mb-2 ml-1">é¸æ“‡ç›¤é»äººå“¡</label>
                    <select v-model="selUser" class="w-full h-12 px-4 border border-gray-300 rounded-xl bg-white shadow-sm mb-6 outline-none focus:border-blue-500 transition">
                        <option value="" disabled>-- è«‹é¸æ“‡ --</option>
                        <option v-for="u in staffList" :value="u">{{ u }}</option>
                    </select>

                    <label class="block text-gray-700 text-sm font-bold mb-2 ml-1">é¸æ“‡ç›¤é»å€åŸŸ</label>
                    <select v-model="selZone" class="w-full h-12 px-4 border border-gray-300 rounded-xl bg-white shadow-sm mb-8 outline-none focus:border-blue-500 transition">
                        <option value="" disabled>-- è«‹é¸æ“‡ --</option>
                        <option v-for="z in zoneList" :value="z">{{ z }}</option>
                    </select>

                    <button @click="startInv" :disabled="!selUser || !selZone" :class="(!selUser || !selZone) ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200'" class="w-full text-white font-bold py-4 rounded-xl transition btn-act mb-6 text-lg">
                        é–‹å§‹ç›¤é» â
                    </button>

                    <div class="grid grid-cols-2 gap-4 md:hidden">
                        <button @click="page='report'" class="bg-white border text-gray-600 font-bold py-3 rounded-xl shadow-sm hover:bg-gray-50 btn-act">ğŸ“Š å ±è¡¨</button>
                        <button @click="enterAdmin" class="bg-white border text-gray-600 font-bold py-3 rounded-xl shadow-sm hover:bg-gray-50 btn-act">âš™ï¸ ç¶­è­·</button>
                    </div>
                    
                    <div class="text-center mt-6 text-xs text-gray-400">Database Size: {{ dbCount }} records</div>
                </div>
            </div>
        </div>

        <div v-else class="flex-1 flex flex-col h-full overflow-hidden bg-gray-100">
            <div class="bg-blue-600 p-3 md:p-4 text-white shadow-md z-10 shrink-0 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
                
                <div class="flex justify-between items-center md:gap-6">
                    <div>
                        <div class="font-bold text-lg md:text-xl leading-tight">{{ selUser }}</div>
                        <div class="text-xs md:text-sm text-blue-200">{{ selZone }}</div>
                    </div>
                    <div class="flex items-center gap-3 md:hidden">
                        <div v-if="isSaving" class="text-xs text-blue-200 animate-pulse">â˜ï¸...</div>
                        <div v-else class="text-xs text-green-300 font-bold">âœ”</div>
                        <button @click="page='home'" class="bg-blue-700/50 border border-blue-400 px-3 py-1 rounded text-xs">é›¢é–‹</button>
                    </div>
                </div>
                
                <div class="flex-1 md:mx-10">
                    <div class="flex justify-between text-xs text-blue-100 mb-1">
                        <span>å®Œæˆé€²åº¦</span>
                        <span class="font-mono">{{ currentProgress.done }}/{{ currentProgress.total }} ({{ currentProgress.pct }}%)</span>
                    </div>
                    <div class="w-full bg-blue-800 h-2 md:h-3 rounded-full overflow-hidden">
                        <div class="bg-green-400 h-full transition-all duration-300" :style="{width: currentProgress.pct+'%'}"></div>
                    </div>
                </div>
                
                <div class="relative flex gap-2 md:w-auto">
                    <div class="relative flex-1 md:w-64">
                        <input v-model="keyword" type="text" placeholder="æœå°‹è—¥å..." class="w-full pl-9 pr-8 py-2 md:py-2.5 rounded-lg text-gray-800 text-sm md:text-base outline-none shadow-inner border-none">
                        <div class="absolute left-2.5 top-2 md:top-3 text-gray-400 pointer-events-none">ğŸ”</div>
                        <button v-if="keyword" @click="keyword=''" class="absolute right-2 top-2 md:top-3 text-gray-400 hover:text-red-500 font-bold">âœ•</button>
                    </div>
                    <button @click="openAddModal" class="bg-green-500 hover:bg-green-600 text-white font-bold px-3 md:px-4 rounded-lg shadow btn-act text-xl flex items-center justify-center" title="ç¾å ´è£œå–®">ï¼‹</button>
                </div>
            </div>

            <div class="bg-white border-b border-gray-200 px-3 py-2 shadow-sm shrink-0">
                <div class="flex items-center gap-2 drag-scroll pb-1" ref="scrollContainer1" @mousedown="startDrag($event, 'scrollContainer1')" @mouseleave="stopDrag" @mouseup="stopDrag" @mousemove="onDrag($event, 'scrollContainer1')">
                    <button @click="showOnlyPending = !showOnlyPending" 
                            class="shrink-0 px-3 py-1.5 rounded-full text-xs md:text-sm font-bold border transition-colors btn-act select-none flex items-center gap-1"
                            :class="showOnlyPending ? 'bg-yellow-100 text-yellow-800 border-yellow-300' : 'bg-gray-100 text-gray-600 border-gray-200'">
                        <span v-if="showOnlyPending">âš¡</span> {{ showOnlyPending ? 'åªçœ‹æœªç›¤' : 'é¡¯ç¤ºå…¨éƒ¨' }}
                    </button>

                    <div class="w-px h-5 bg-gray-300 shrink-0 mx-1"></div>

                    <button @click="resetFilters" 
                            class="shrink-0 px-3 py-1.5 rounded-full text-xs md:text-sm font-bold border transition-colors btn-act select-none"
                            :class="!selGroup && !selShelf ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'">
                        å…¨éƒ¨
                    </button>
                    
                    <button v-for="item in navItems" :key="item.value" @click="handleNavClick(item)" 
                            class="shrink-0 px-3 py-1.5 rounded-full text-xs md:text-sm font-bold border transition-colors btn-act flex items-center gap-1 select-none"
                            :class="isActiveNav(item) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'">
                        <span v-if="item.type==='group'">ğŸ“‚</span>
                        {{ item.label }}
                    </button>
                </div>

                <div v-if="selGroup" class="flex items-center gap-2 drag-scroll pb-1 pt-2 mt-1 border-t border-gray-100" ref="scrollContainer2" @mousedown="startDrag($event, 'scrollContainer2')" @mouseleave="stopDrag" @mouseup="stopDrag" @mousemove="onDrag($event, 'scrollContainer2')">
                    <span class="text-[10px] text-gray-400 font-bold shrink-0 select-none uppercase tracking-wide">Sub:</span>
                    <button v-for="s in currentSubShelves" :key="s" @click="selShelf=s"
                            class="shrink-0 px-2 py-0.5 rounded-md text-xs font-bold border transition-colors btn-act select-none"
                            :class="selShelf===s ? 'bg-blue-100 text-blue-800 border-blue-300' : 'bg-gray-50 text-gray-500 border-gray-200'">
                        {{ s }}
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-3 pb-32 custom-scroll">
                
                <div v-if="displayList.length === 0" class="flex flex-col items-center justify-center mt-20 text-gray-400">
                    <div class="text-5xl mb-3">ğŸ“­</div>
                    <p class="text-lg">ç„¡è³‡æ–™</p>
                    <button @click="openAddModal" class="mt-4 text-blue-600 underline">æ–°å¢è—¥å“?</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    
                    <div v-for="item in displayList" :key="item.id" 
                         class="bg-white rounded-xl shadow-sm p-4 border-l-[6px] transition-all duration-200 hover:shadow-md flex flex-col justify-between" 
                         :class="isDone(item) ? 'border-green-500 bg-green-50/30' : 'border-red-400'">
                        
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1 min-w-0 pr-2">
                                <div class="font-bold text-gray-800 text-lg leading-tight mb-1 flex items-center flex-wrap gap-2">
                                    <span class="truncate">{{ item.name }}</span>
                                    <span v-if="item.isManual" class="shrink-0 text-[10px] bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded border border-purple-200">è£œå–®</span>
                                    <span v-if="item.isModified" class="shrink-0 text-[10px] bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded border border-orange-200">ç•°å‹•</span>
                                </div>
                                <div class="text-xs text-gray-500 font-mono flex items-center flex-wrap gap-2">
                                    <span>{{ item.code }}</span>
                                    <span @click.stop="editField(item, 'shelf')" class="bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded cursor-pointer hover:bg-gray-200 border border-gray-200 editable" title="ä¿®æ”¹å„²ä½">
                                        {{ item.shelf }} âœï¸
                                    </span>
                                </div>
                                <div class="mt-2 flex flex-wrap gap-1">
                                    <span v-if="item.units?.lg?.cap > 0" @click.stop="editField(item, 'lgCap')" class="text-xs px-1.5 py-0.5 bg-blue-50 border border-blue-100 rounded text-blue-600 cursor-pointer hover:bg-blue-100 editable">1{{ item.units.lg.name }}={{ item.units.lg.cap }}</span>
                                    <span v-if="item.units?.sm?.cap > 1" @click.stop="editField(item, 'smCap')" class="text-xs px-1.5 py-0.5 bg-green-50 border border-green-100 rounded text-green-600 cursor-pointer hover:bg-green-100 editable">1{{ item.units.sm.name }}={{ item.units.sm.cap }}</span>
                                </div>
                            </div>
                            
                            <div class="text-right flex flex-col items-end shrink-0">
                                <div v-if="isDone(item)">
                                    <div class="text-3xl font-bold text-green-600 leading-none">{{ calcTotal(item) }}</div>
                                    <div class="text-[10px] text-gray-400 mt-1">{{ item.user }}</div>
                                </div>
                                <div v-else class="text-lg font-bold text-red-400 bg-red-50 px-2 py-0.5 rounded mb-1">æœªç›¤</div>
                                <button v-if="!isDone(item)" @click="setZero(item)" class="text-xs bg-gray-500 text-white px-2 py-1 rounded shadow hover:bg-gray-600 btn-act">ç„¡åº«å­˜</button>
                            </div>
                        </div>

                        <div v-if="expiryZones.includes(item.zone)" class="bg-gray-50 p-2 rounded-lg border border-gray-200 text-sm">
                             <div v-for="(batch, idx) in item.batches" :key="idx" class="flex gap-2 mb-2 items-center">
                                <input type="date" v-model="batch.expiry" @change="save(item)" class="flex-1 h-8 rounded border border-gray-300 text-center text-sm">
                                <input type="number" v-model.number="batch.qty" @input="save(item)" class="w-16 h-8 rounded border border-gray-300 text-center font-bold" placeholder="æ•¸é‡">
                                <button @click="removeBatch(item, idx)" class="w-8 h-8 bg-red-100 text-red-500 rounded font-bold hover:bg-red-200">âœ•</button>
                             </div>
                             <button @click="addBatch(item)" class="w-full py-1.5 bg-green-50 text-green-600 font-bold rounded border border-dashed border-green-300 hover:bg-green-100 text-xs">ï¼‹ æ•ˆæœŸ</button>
                        </div>

                        <div v-else class="grid grid-cols-3 gap-2 mt-auto">
                            <div v-if="item.units?.lg?.cap > 0" class="flex flex-col items-center">
                                <label class="text-[10px] text-gray-500 mb-0.5 font-bold">{{ item.units.lg.name }}</label>
                                <div class="flex w-full gap-0.5">
                                    <button @click="adj(item, 'lg', -1)" class="w-6 bg-gray-200 rounded hover:bg-gray-300">-</button>
                                    <input type="number" v-model.number="item.inputs.lg" @input="save(item)" @focus="$event.target.select()" class="input-box h-8 text-lg" :class="item.inputs.lg!==0?'input-filled':'input-empty'" placeholder="0">
                                    <button @click="adj(item, 'lg', 1)" class="w-6 bg-gray-200 rounded hover:bg-gray-300">+</button>
                                </div>
                            </div>
                            <div v-else class="flex justify-center items-center opacity-10 text-xs bg-gray-50 rounded">-</div>

                            <div v-if="item.units?.sm?.cap > 1" class="flex flex-col items-center">
                                <label class="text-[10px] text-gray-500 mb-0.5 font-bold">{{ item.units.sm.name }}</label>
                                <div class="flex w-full gap-0.5">
                                    <button @click="adj(item, 'sm', -1)" class="w-6 bg-gray-200 rounded hover:bg-gray-300">-</button>
                                    <input type="number" v-model.number="item.inputs.sm" @input="save(item)" @focus="$event.target.select()" class="input-box h-8 text-lg" :class="item.inputs.sm!==0?'input-filled':'input-empty'" placeholder="0">
                                    <button @click="adj(item, 'sm', 1)" class="w-6 bg-gray-200 rounded hover:bg-gray-300">+</button>
                                </div>
                            </div>
                            <div v-else class="flex justify-center items-center opacity-10 text-xs bg-gray-50 rounded">-</div>

                            <div class="flex flex-col items-center">
                                <label class="text-[10px] text-gray-500 mb-0.5 font-bold">{{ item.units.lo?.name || 'é¡†' }}</label>
                                <div class="flex w-full gap-0.5">
                                    <button @click="adj(item, 'lo', -1)" class="w-6 bg-gray-200 rounded hover:bg-gray-300">-</button>
                                    <input type="number" v-model.number="item.inputs.lo" @input="save(item)" @focus="$event.target.select()" class="input-box h-8 text-lg" :class="item.inputs.lo!==0?'input-filled':'input-empty'" placeholder="0">
                                    <button @click="adj(item, 'lo', 1)" class="w-6 bg-gray-200 rounded hover:bg-gray-300">+</button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showAddModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 modal-backdrop" @click.self="showAddModal=false">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-bounce-in">
            <div class="bg-green-600 p-4 text-white font-bold text-lg flex justify-between items-center">
                <span>â• ç¾å ´è£œå–®</span>
                <button @click="showAddModal=false" class="text-white hover:text-red-200">âœ•</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-gray-700 font-bold mb-1 text-sm">è—¥å“ä»£ç¢¼ *</label>
                    <input v-model="newItem.code" type="text" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none">
                </div>
                <div>
                    <label class="block text-gray-700 font-bold mb-1 text-sm">è—¥å“åç¨± *</label>
                    <input v-model="newItem.name" type="text" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:border-green-500 outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded-lg">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">å¤§åŒ…è£ (ç›’)</label>
                        <input v-model.number="newItem.lgCap" type="number" class="w-full p-2 border rounded text-center">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">å°åŒ…è£ (æ’)</label>
                        <input v-model.number="newItem.smCap" type="number" class="w-full p-2 border rounded text-center">
                    </div>
                </div>
                <button @click="confirmAdd" class="w-full bg-green-600 text-white font-bold py-3 rounded-xl shadow hover:bg-green-700 btn-act">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
    window.onerror = function(msg, url, line) {
        const el = document.getElementById('crash-log');
        el.style.display = 'block';
        el.innerHTML += `âŒ ${msg} (Line: ${line})<br>`;
        return false;
    };

    import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZuNztwb9aLG1RqeDOyrj6KJrPhwBFi9M",
      authDomain: "fyh-pharmacy-inventory.firebaseapp.com",
      databaseURL: "https://fyh-pharmacy-inventory-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fyh-pharmacy-inventory",
      storageBucket: "fyh-pharmacy-inventory.firebasestorage.app",
      messagingSenderId: "751378148626",
      appId: "1:751378148626:web:5a2d2be1c5f905657457cb",
      measurementId: "G-0X63VL8KMR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            const page = ref('home');
            const isOnline = ref(false);
            const isSaving = ref(false);
            const isUploading = ref(false);
            const staffList = ref([]);
            const inventory = ref([]);
            const selUser = ref('');
            const selZone = ref('');
            const keyword = ref('');
            
            const showOnlyPending = ref(false);
            const selGroup = ref('');
            const selShelf = ref('');

            const showAddModal = ref(false);
            const newItem = ref({ code: '', name: '', lgCap: 0, smCap: 0 });

            const expiryZones = ['é»æ»´ER', 'é»æ»´OPD'];

            // Drag Scrolling State
            const isDragging = ref(false);
            const startX = ref(0);
            const scrollLeft = ref(0);

            onMounted(() => {
                onValue(dbRef(db, ".info/connected"), s => isOnline.value = s.val());
                onValue(dbRef(db, "staff"), s => staffList.value = s.val() || []);
                onValue(dbRef(db, "inventory"), s => {
                    const data = s.val();
                    if (!data) { inventory.value = []; return; }
                    const arr = Array.isArray(data) ? data : Object.values(data);
                    
                    inventory.value = arr.map(item => {
                        if (!item) return null;
                        if (!item.inputs) item.inputs = { lg: 0, sm: 0, lo: 0 };
                        if (!item.units) item.units = { lg: {cap:0,name:'ç›’'}, sm: {cap:0,name:'æ’'}, lo: {name:'æ”¯'} };
                        if (item.done === undefined) item.done = false;
                        if (!item.user) item.user = '';
                        if (!item.code) item.code = '???';
                        if (!item.name) item.name = 'æœªçŸ¥è—¥å“';
                        if (item.isManual === undefined) item.isManual = false;
                        if (item.isModified === undefined) item.isModified = false;
                        item.shelf = String(item.shelf || '');
                        if (!item.batches) item.batches = [{ expiry: '', qty: 0 }];
                        return item;
                    }).filter(x => x !== null);
                });
            });

            watch(selZone, () => { resetFilters(); });

            const resetFilters = () => {
                selGroup.value = '';
                selShelf.value = '';
                showOnlyPending.value = false;
                keyword.value = '';
            };

            const dbCount = computed(() => inventory.value.length);
            const staffCount = computed(() => staffList.value.length);
            const zoneList = computed(() => [...new Set(inventory.value.map(i => i.zone))].sort());
            
            const getGroup = (shelf) => {
                if (!shelf) return 'å…¶ä»–';
                const s = String(shelf).trim();
                const keywords = ['æ©Ÿå™¨', 'å¤–ç”¨', 'å¤–çœ¼'];
                for (const k of keywords) {
                    if (s.startsWith(k)) return k; 
                }
                const match = s.match(/^([^\d]+)/);
                if (match) return match[1];
                if (/^\d+$/.test(s)) return 'å…¶ä»–';
                return 'å…¶ä»–';
            };

            const navItems = computed(() => {
                try {
                    const currentItems = inventory.value.filter(i => i.zone === selZone.value && i.shelf);
                    const groups = {}; 
                    currentItems.forEach(i => {
                        const g = getGroup(i.shelf);
                        if (!groups[g]) groups[g] = new Set();
                        groups[g].add(i.shelf);
                    });

                    const items = [];
                    const sortedGroups = Object.keys(groups).sort();

                    sortedGroups.forEach(g => {
                        const shelves = Array.from(groups[g]);
                        if (shelves.length === 1) {
                            items.push({ label: shelves[0], value: shelves[0], type: 'shelf' });
                        } else {
                            items.push({ label: g, value: g, type: 'group' });
                        }
                    });
                    return items;
                } catch(e) { return []; }
            });

            const handleNavClick = (item) => {
                if (item.type === 'group') {
                    selGroup.value = item.value;
                    selShelf.value = '';
                } else {
                    selShelf.value = item.value;
                    selGroup.value = '';
                }
            };

            const isActiveNav = (item) => {
                if (item.type === 'group') return selGroup.value === item.value;
                return selShelf.value === item.value;
            };

            const currentSubShelves = computed(() => {
                if (!selGroup.value) return [];
                const items = inventory.value.filter(i => i.zone === selZone.value);
                const shelves = new Set();
                items.forEach(i => {
                    if (getGroup(i.shelf) === selGroup.value) shelves.add(i.shelf);
                });
                return Array.from(shelves).sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }));
            });

            const displayList = computed(() => {
                if (!selZone.value) return [];
                let list = inventory.value.filter(i => i.zone === selZone.value);
                
                if (keyword.value) {
                    const k = keyword.value.trim().toLowerCase();
                    list = list.filter(i => (i.name && i.name.toLowerCase().includes(k)) || (i.code && i.code.toLowerCase().includes(k)));
                }

                if (selShelf.value) {
                    list = list.filter(i => i.shelf === selShelf.value);
                } else if (selGroup.value) {
                    list = list.filter(i => getGroup(i.shelf) === selGroup.value);
                }

                if (showOnlyPending.value) {
                    list = list.filter(i => !isDone(i));
                }

                return list;
            });

            // Drag Scrolling
            const startDrag = (e, refName) => {
                isDragging.value = true;
                const container = document.querySelector(`[ref="${refName}"]`) || e.currentTarget;
                if(!container) return;
                startX.value = e.pageX - container.offsetLeft;
                scrollLeft.value = container.scrollLeft;
            };
            const stopDrag = () => { isDragging.value = false; };
            const onDrag = (e, refName) => {
                if (!isDragging.value) return;
                e.preventDefault();
                const container = document.querySelector(`[ref="${refName}"]`) || e.currentTarget;
                if(!container) return;
                const x = e.pageX - container.offsetLeft;
                const walk = (x - startX.value) * 2; 
                container.scrollLeft = scrollLeft.value - walk;
            };

            const currentProgress = computed(() => {
                const list = inventory.value.filter(i => i.zone === selZone.value);
                const total = list.length;
                if (total === 0) return { total: 0, done: 0, pct: 0 };
                const done = list.filter(isDone).length;
                return { total, done, pct: Math.round((done/total)*100) };
            });

            const zoneStats = computed(() => {
                const stats = {};
                zoneList.value.forEach(z => stats[z] = { name: z, total: 0, done: 0, hasManual: false, hasModified: false });
                inventory.value.forEach(i => {
                    if (stats[i.zone]) {
                        stats[i.zone].total++;
                        if (isDone(i)) stats[i.zone].done++;
                        if (i.isManual) stats[i.zone].hasManual = true;
                        if (i.isModified) stats[i.zone].hasModified = true;
                    }
                });
                return Object.values(stats).map(s => ({ ...s, pct: s.total===0 ? 0 : Math.round((s.done/s.total)*100) }));
            });

            const isDone = (item) => {
                if (expiryZones.includes(item.zone)) {
                    const total = item.batches.reduce((acc, cur) => acc + cur.qty, 0);
                    return total > 0 || item.done;
                }
                return (item.inputs.lg !== 0 || item.inputs.sm !== 0 || item.inputs.lo !== 0 || item.done);
            };
            
            const calcTotal = (item) => {
                if (expiryZones.includes(item.zone)) {
                    return item.batches.reduce((acc, cur) => acc + cur.qty, 0);
                }
                const lg = item.units?.lg?.cap || 0;
                const sm = item.units?.sm?.cap || 0;
                return (item.inputs.lg * lg) + (item.inputs.sm * sm) + item.inputs.lo;
            };

            const startInvCheck = () => {
                if(selUser.value && selZone.value) page.value = 'work';
                else { alert("è«‹å…ˆåœ¨é¦–é é¸æ“‡äººå“¡èˆ‡å€åŸŸ"); page.value='home'; }
            };
            const startInv = () => { if (selUser.value && selZone.value) page.value = 'work'; };
            const enterAdmin = () => { if (prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼") === "8888") page.value = 'admin'; };
            
            let timerMap = {};
            const save = (item) => {
                isSaving.value = true; item.done = true; item.user = selUser.value; item.time = new Date().toISOString();
                const idx = inventory.value.findIndex(x => x.id === item.id);
                if (idx === -1) return;
                clearTimeout(timerMap[item.id]);
                timerMap[item.id] = setTimeout(() => {
                    update(dbRef(db, `inventory/${idx}`), {
                        inputs: item.inputs, user: item.user, time: item.time, done: true, batches: item.batches
                    }).then(() => isSaving.value = false).catch(e => console.error(e));
                }, 500);
            };

            const editField = (item, type) => {
                const pwd = prompt("âš ï¸ ä¿®æ”¹è³‡æ–™å®‰å…¨æª¢æŸ¥\nè«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š");
                if (pwd !== '8888') { if (pwd !== null) alert("âŒ å¯†ç¢¼éŒ¯èª¤ï¼Œæ‹’çµ•å­˜å–"); return; }
                const idx = inventory.value.findIndex(x => x.id === item.id);
                if (idx === -1) { alert("ç³»çµ±éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°åŸå§‹è³‡æ–™"); return; }
                let newValue; let updatePayload = {};
                if (type === 'shelf') {
                    newValue = prompt("âœï¸ è«‹è¼¸å…¥æ–°çš„å„²ä½ï¼š", item.shelf);
                    if (newValue === null) return;
                    item.shelf = String(newValue); updatePayload = { shelf: String(newValue) };
                } else if (type === 'lgCap') {
                    newValue = prompt(`âœï¸ ä¿®æ”¹ ${item.units.lg.name} çš„å®¹é‡\n(åŸ: ${item.units.lg.cap})ï¼š`, item.units.lg.cap);
                    if (newValue === null) return;
                    const num = parseInt(newValue);
                    if (isNaN(num)) { alert("è«‹è¼¸å…¥æ•¸å­—"); return; }
                    item.units.lg.cap = num; updatePayload = { "units/lg/cap": num };
                } else if (type === 'smCap') {
                    newValue = prompt(`âœï¸ ä¿®æ”¹ ${item.units.sm.name} çš„å®¹é‡\n(åŸ: ${item.units.sm.cap})ï¼š`, item.units.sm.cap);
                    if (newValue === null) return;
                    const num = parseInt(newValue);
                    if (isNaN(num)) { alert("è«‹è¼¸å…¥æ•¸å­—"); return; }
                    item.units.sm.cap = num; updatePayload = { "units/sm/cap": num };
                }
                item.isModified = true; updatePayload.isModified = true;
                isSaving.value = true;
                update(dbRef(db, `inventory/${idx}`), updatePayload).then(() => { isSaving.value = false; alert("âœ… ä¿®æ”¹æˆåŠŸï¼"); }).catch(e => { isSaving.value = false; alert("âŒ æ›´æ–°å¤±æ•—ï¼š" + e.message); });
            };

            const setZero = (item) => {
                if (expiryZones.includes(item.zone)) item.batches = [{ expiry: '', qty: 0 }];
                else { item.inputs.lg = 0; item.inputs.sm = 0; item.inputs.lo = 0; }
                save(item);
            };
            
            const addBatch = (item) => { item.batches.push({ expiry: '', qty: 0 }); save(item); };
            const removeBatch = (item, idx) => {
                if (item.batches.length > 1) { item.batches.splice(idx, 1); save(item); }
                else { item.batches[0].qty = 0; item.batches[0].expiry = ''; save(item); }
            };

            const resetDatabase = () => {
                if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
                    set(dbRef(db, "inventory"), null); set(dbRef(db, "staff"), null); alert("å·²é‡ç½®è³‡æ–™åº«");
                }
            };

            const openAddModal = () => { newItem.value = { code: '', name: '', lgCap: 0, smCap: 0 }; showAddModal.value = true; };
            const confirmAdd = () => {
                if (!newItem.value.code || !newItem.value.name) { alert("è«‹å¡«å¯«ä»£ç¢¼èˆ‡åç¨±"); return; }
                const newIdx = inventory.value.length;
                const itemData = {
                    id: `${selZone.value}_${newItem.value.code}_MANUAL`, code: newItem.value.code, name: newItem.value.name,
                    zone: selZone.value, shelf: 'æ‰‹å‹•',
                    units: { lg: { cap: newItem.value.lgCap, name: 'ç›’' }, sm: { cap: newItem.value.smCap, name: 'æ’' }, lo: { name: 'é¡†/æ”¯' } },
                    inputs: { lg: 0, sm: 0, lo: 0 }, done: false, user: selUser.value, time: new Date().toISOString(),
                    batches: [{ expiry: '', qty: 0 }], isManual: true, isModified: false
                };
                update(dbRef(db, `inventory/${newIdx}`), itemData).then(() => { alert("æ–°å¢æˆåŠŸï¼"); showAddModal.value = false; keyword.value = newItem.value.code; });
            };

            const uploadStaff = (e) => {
                const f = e.target.files[0]; if (!f) return;
                const r = new FileReader(); r.onload = (evt) => {
                    const txt = evt.target.result.replace(/\r\n/g, ',').replace(/\n/g, ',');
                    const arr = txt.split(',').map(x => x.trim()).filter(x => x);
                    if (arr.length > 0) { set(dbRef(db, "staff"), arr); alert(`å·²åŒ¯å…¥ ${arr.length} ä½äººå“¡`); }
                }; r.readAsText(f);
            };

            const uploadInventory = async (e) => {
                const files = e.target.files; if (!files.length) return;
                isUploading.value = true;
                try {
                    let allItems = [];
                    for (let i=0; i<files.length; i++) {
                        const file = files[i];
                        let zName = file.name.replace(/\.(csv|xlsx|xls)$/, '');
                        const m = zName.match(/[-_]\s*(.+)/); if (m) zName = m[1].trim();
                        const items = await parseFile(file, zName);
                        allItems = allItems.concat(items);
                    }
                    if (allItems.length > 0) {
                        if (confirm(`æº–å‚™è¦†è“‹ä¸Šå‚³ ${allItems.length} ç­†è—¥å“ï¼Ÿ`)) {
                            const cleanData = JSON.parse(JSON.stringify(allItems));
                            await set(dbRef(db, "inventory"), cleanData);
                            alert("ä¸Šå‚³æˆåŠŸï¼");
                        }
                    } else { alert("è®€å–å¤±æ•—"); }
                } catch(err) { alert("ä¸Šå‚³éŒ¯èª¤: " + err); }
                isUploading.value = false;
            };

            const parseFile = (file, zone) => {
                return new Promise(resolve => {
                    const r = new FileReader();
                    r.onload = (e) => {
                        try {
                            const wb = XLSX.read(e.target.result, { type: 'binary' });
                            const sheet = wb.Sheets[wb.SheetNames[0]];
                            const rows = XLSX.utils.sheet_to_json(sheet, { header:1, defval:'' });
                            let headIdx = -1;
                            for(let r=0; r<Math.min(rows.length, 20); r++) {
                                const str = rows[r].join(' ');
                                if (str.includes('ä»£ç¢¼') || str.toLowerCase().includes('code')) { headIdx = r; break; }
                            }
                            if (headIdx === -1) headIdx = 0;
                            const clean = (s) => String(s).replace(/[\(\)\/\s]/g, '');
                            const header = rows[headIdx].map(x => String(x).trim());
                            const idxMap = {
                                code: header.findIndex(x => x.includes('ä»£ç¢¼') || x.toLowerCase().includes('code')),
                                name: header.findIndex(x => x.includes('åç¨±') || x.toLowerCase().includes('name')),
                                shelf: header.findIndex(x => x.includes('å„²ä½') || x.includes('é–€ç‰Œ')),
                                lgCap: header.findIndex(x => { const c = clean(x); return c.includes('å¤§åŒ…è£') && c.includes('é‡'); }),
                                lgUnit: header.findIndex(x => { const c = clean(x); return c.includes('å¤§åŒ…è£') && (c.includes('å–®ä½') || c.includes('unit')); }),
                                smCap: header.findIndex(x => { const c = clean(x); return c.includes('å°åŒ…è£') && c.includes('é‡'); }),
                                smUnit: header.findIndex(x => { const c = clean(x); return c.includes('å°åŒ…è£') && (c.includes('å–®ä½') || c.includes('unit')); }),
                            };
                            if (idxMap.code === -1) {
                                idxMap.code=0; idxMap.name=1; idxMap.shelf=3;
                                idxMap.lgCap=4; idxMap.lgUnit=5;
                                idxMap.smCap=6; idxMap.smUnit=7;
                            }
                            const parsed = [];
                            for(let r=headIdx+1; r<rows.length; r++) {
                                const row = rows[r];
                                const code = row[idxMap.code] ? String(row[idxMap.code]).trim() : '';
                                if (!code) continue;
                                let lgCap = parseInt(row[idxMap.lgCap]) || 0;
                                let lgName = row[idxMap.lgUnit] ? String(row[idxMap.lgUnit]).replace(/[\/x]/g,'').trim() : 'ç›’';
                                let smCap = parseInt(row[idxMap.smCap]);
                                if (isNaN(smCap)) smCap = 0; 
                                let smName = row[idxMap.smUnit] ? String(row[idxMap.smUnit]).replace(/[\/x]/g,'').trim() : '';
                                let loName = 'é¡†/æ”¯'; 
                                if (smCap <= 1) { if (smName) loName = smName; smCap = 0; smName = ''; } else { if (!smName) smName = 'æ’'; }
                                if (!isNaN(parseFloat(lgName)) || lgName.length > 5) lgName = 'ç›’';
                                parsed.push({
                                    id: `${zone}_${code}_${r}`, code, name: row[idxMap.name] || 'ç„¡å“å', shelf: row[idxMap.shelf] || '', zone,
                                    units: { lg: { cap: lgCap, name: lgName }, sm: { cap: smCap, name: smName }, lo: { name: loName } },
                                    inputs: { lg: 0, sm: 0, lo: 0 }, done: false, batches: [{ expiry: '', qty: 0 }], isManual: false, isModified: false
                                });
                            }
                            resolve(parsed);
                        } catch(err) { resolve([]); }
                    };
                    r.readAsBinaryString(file);
                });
            };

            const exportZone = (z) => {
                const data = inventory.value.filter(x => x.zone === z).map(x => {
                    let qtyStr = ''; let expiryStr = '';
                    if (expiryZones.includes(x.zone)) {
                        const validBatches = x.batches.filter(b => b.qty > 0);
                        if (validBatches.length > 0) {
                            qtyStr = validBatches.map(b => `${b.qty}`).join(', ');
                            expiryStr = validBatches.map(b => b.expiry || 'ç„¡æ•ˆæœŸ').join(', ');
                        } else { qtyStr = '0'; }
                    } else {
                        qtyStr = isDone(x) ? `${x.inputs.lg}${x.units?.lg?.name} ${x.inputs.sm}${x.units?.sm?.name} ${x.inputs.lo.name}`.trim() : 'æœªç›¤';
                    }
                    let status = []; if (x.isManual) status.push('è£œå–®'); if (x.isModified) status.push('ç•°å‹•');
                    return {
                        'ä»£ç¢¼': x.code, 'åç¨±': x.name, 'å„²ä½': x.shelf, 'ç›¤é»é‡': qtyStr, 'ç¸½é‡': isDone(x) ? calcTotal(x) : 0, 
                        'æ•ˆæœŸ': expiryStr, 'ç‹€æ…‹': status.join(','), 'ç›¤é»äºº': x.user || '', 'æ™‚é–“': x.time ? new Date(x.time).toLocaleString() : ''
                    };
                });
                dlExcel(data, `ç›¤é»_${z}`);
            };

            const exportTotal = () => {
                const map = {};
                inventory.value.forEach(x => {
                    if (!map[x.code]) map[x.code] = { code:x.code, name:x.name, total:0, expiry:'', status:[] };
                    if (x.isManual) map[x.code].status.push('è£œå–®');
                    if (x.isModified) map[x.code].status.push('ç•°å‹•');
                    if (isDone(x)) {
                        const t = calcTotal(x); map[x.code][x.zone] = t; map[x.code].total += t;
                        if (expiryZones.includes(x.zone)) {
                             const exps = x.batches.filter(b=>b.qty>0 && b.expiry).map(b=>b.expiry).join(',');
                             if(exps) map[x.code].expiry = exps;
                        }
                    }
                });
                const exportData = Object.values(map).map(item => { item.status = [...new Set(item.status)].join(','); return item; });
                dlExcel(exportData, 'å…¨é™¢ç¸½è¡¨');
            };

            const dlExcel = (json, fname) => {
                const ws = XLSX.utils.json_to_sheet(json); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sheet1"); XLSX.writeFile(wb, `${fname}.xlsx`);
            };
            
            const adj = (item, type, val) => { item.inputs[type] += val; if (item.inputs[type] < 0) item.inputs[type] = 0; save(item); };

            return {
                page, isOnline, isSaving, isUploading, selUser, selZone, keyword, staffList, dbCount, staffCount, zoneList, displayList, currentProgress, zoneStats,
                startInv, enterAdmin, resetDatabase, uploadStaff, uploadInventory, save, setZero, isDone, calcTotal, exportZone, exportTotal,
                showAddModal, newItem, openAddModal, confirmAdd, expiryZones, addBatch, removeBatch, showOnlyPending, selShelf, selGroup, currentSubShelves, resetFilters, navItems, handleNavClick, isActiveNav, startDrag, stopDrag, onDrag, editField, adj, startInvCheck
            };
        }
    }).mount('#app');
</script>
</body>
</html>
