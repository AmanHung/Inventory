<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥å±€ç›¤é»ç³»çµ± v5.17 (å„²ä½åˆ†å±¤å°èˆªç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/shim.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* UI åŸºç¤è¨­å®š */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f3f4f6; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none;
        }
        
        .btn-act { transition: transform 0.1s; }
        .btn-act:active { transform: scale(0.95); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .dot-green { background: #22c55e; box-shadow: 0 0 4px #22c55e; }
        .dot-red { background: #ef4444; }
        .custom-scroll { -webkit-overflow-scrolling: touch; }
        
        /* éš±è—æ²è»¸ä½†ä¿ç•™æ²å‹•åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body>

<div id="crash-log" style="display:none; position:fixed; bottom:0; left:0; right:0; background:#7f1d1d; color:#fff; padding:10px; font-size:12px; z-index:9999; max-height:150px; overflow:auto;"></div>

<div id="app" class="w-full max-w-md mx-auto h-[100dvh] bg-white shadow-2xl flex flex-col relative border-x border-gray-200 overflow-hidden">

    <div v-if="page === 'admin'" class="flex-1 p-6 bg-gray-50 overflow-y-auto">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center gap-2">âš™ï¸ ç³»çµ±ç¶­è­·</h2>
        
        <div class="bg-red-50 p-4 rounded-lg border border-red-200 mb-6">
            <h3 class="font-bold text-xl text-red-800 mb-2">âš ï¸ å±éšªå€åŸŸ</h3>
            <div class="text-sm text-red-600 mb-2">è‹¥å–®ä½é¡¯ç¤ºä¸æ­£ç¢ºï¼Œè«‹å…ˆæ¸…ç©ºè³‡æ–™å¾Œé‡æ–°åŒ¯å…¥</div>
            <button @click="resetDatabase" class="w-full bg-red-600 text-white font-bold text-lg py-4 rounded-xl shadow hover:bg-red-700 btn-act">ğŸ”¥ æ¸…ç©ºæ‰€æœ‰é›²ç«¯è³‡æ–™</button>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mb-4">
            <h3 class="font-bold text-lg text-gray-700 mb-2">1. æ›´æ–°äººå“¡åå–®</h3>
            <input type="file" ref="fileStaff" accept=".csv,.txt" class="hidden" @change="uploadStaff">
            <button @click="$refs.fileStaff.click()" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 text-lg hover:border-blue-500 hover:text-blue-500 transition btn-act">é¸æ“‡äººå“¡ CSV</button>
            <div v-if="staffCount > 0" class="text-sm text-green-600 mt-2 text-center">ç›®å‰æœ‰ {{ staffCount }} ä½äººå“¡</div>
        </div>

        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 mb-6">
            <h3 class="font-bold text-lg text-gray-700 mb-2">2. æ›´æ–°ç›¤é»è¡¨</h3>
            <div class="text-sm text-gray-400 mb-2">æ”¯æ´æ¬„ä½ï¼šä»£ç¢¼, åç¨±, å„²ä½, (é‡/å¤§åŒ…è£), å¤§åŒ…è£å–®ä½, (é‡/å°åŒ…è£), å°åŒ…è£å–®ä½</div>
            <input type="file" ref="fileInv" multiple accept=".csv,.xlsx,.xls" class="hidden" @change="uploadInventory">
            <button @click="$refs.fileInv.click()" class="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 text-lg hover:border-blue-500 hover:text-blue-500 transition btn-act">é¸æ“‡ç›¤é»è¡¨ (æ”¯æ´å¤šæª”)</button>
            <div v-if="isUploading" class="mt-2 text-center text-blue-600 text-base flex justify-center items-center gap-2"><div class="loader"></div> è™•ç†ä¸­...</div>
            <div v-if="dbCount > 0" class="text-sm text-green-600 mt-2 text-center">é›²ç«¯å·²æœ‰ {{ dbCount }} ç­†è—¥å“</div>
        </div>

        <button @click="page='home'" class="w-full bg-gray-600 text-white py-4 text-lg rounded-xl shadow hover:bg-gray-700 btn-act">è¿”å›é¦–é </button>
    </div>

    <div v-else-if="page === 'report'" class="flex-1 p-6 bg-gray-50 overflow-y-auto">
        <h2 class="text-3xl font-bold text-gray-800 mb-4 flex items-center gap-2">ğŸ“Š å ±è¡¨ä¸­å¿ƒ</h2>
        <div class="space-y-4 mb-6">
            <div v-for="z in zoneStats" :key="z.name" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <div class="font-bold text-xl text-gray-800">{{ z.name }}</div>
                        <div class="text-sm text-gray-500">{{ z.done }}/{{ z.total }} ({{ z.pct }}%)</div>
                    </div>
                    <button @click="exportZone(z.name)" class="text-sm px-4 py-2 rounded border transition btn-act font-bold" :class="z.pct===100 ? 'bg-green-100 text-green-800 border-green-300' : 'bg-gray-50 text-gray-600'">
                        {{ z.pct===100 ? 'âœ… å®Œæˆ' : 'ğŸ“¥ åŒ¯å‡º' }}
                    </button>
                </div>
                <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
                    <div class="h-full transition-all duration-500" :class="z.pct===100?'bg-green-500':(z.pct>50?'bg-yellow-400':'bg-red-500')" :style="{width: z.pct+'%'}"></div>
                </div>
            </div>
        </div>
        <button @click="exportTotal" class="w-full bg-purple-600 text-white font-bold text-lg py-4 rounded-xl shadow hover:bg-purple-700 mb-4 btn-act">åŒ¯å‡ºå…¨é™¢ç¸½è¡¨</button>
        <button @click="page='home'" class="w-full bg-gray-500 text-white py-4 text-lg rounded-xl shadow hover:bg-gray-600 btn-act">è¿”å›é¦–é </button>
    </div>

    <div v-else-if="page === 'home'" class="flex-1 flex flex-col justify-center items-center p-8 bg-blue-50 overflow-y-auto">
        <div class="w-full max-w-sm">
            <h1 class="text-4xl font-extrabold text-blue-900 text-center mb-2">è—¥å±€ç›¤é»ç³»çµ±</h1>
            <p class="text-center text-gray-400 text-sm mb-10 tracking-widest">FIREBASE V5.17</p>

            <div v-if="!isOnline" class="bg-red-100 text-red-700 p-4 rounded-xl mb-6 text-center text-base font-bold">é€£ç·šä¸­æ–·ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</div>

            <div v-if="dbCount === 0" class="bg-yellow-50 border border-yellow-200 p-6 rounded-xl text-center mb-6">
                <p class="text-yellow-800 font-bold text-lg mb-2">å°šæœªå»ºç«‹è³‡æ–™åº«</p>
                <button @click="enterAdmin" class="text-sm bg-yellow-200 px-4 py-2 rounded text-yellow-800 hover:bg-yellow-300 btn-act">å‰å¾€å¾Œå°åŒ¯å…¥</button>
            </div>

            <div v-else>
                <label class="block text-gray-700 text-base font-bold mb-2">ç›¤é»äººå“¡</label>
                <select v-model="selUser" class="w-full h-14 px-4 border rounded-xl bg-white shadow-sm mb-6 outline-none text-xl">
                    <option value="" disabled>-- è«‹é¸æ“‡äººå“¡ --</option>
                    <option v-for="u in staffList" :value="u">{{ u }}</option>
                </select>

                <label class="block text-gray-700 text-base font-bold mb-2">ç›¤é»å€åŸŸ</label>
                <select v-model="selZone" class="w-full h-14 px-4 border rounded-xl bg-white shadow-sm mb-8 outline-none text-xl">
                    <option value="" disabled>-- è«‹é¸æ“‡å€åŸŸ --</option>
                    <option v-for="z in zoneList" :value="z">{{ z }}</option>
                </select>

                <button @click="startInv" :disabled="!selUser || !selZone" :class="(!selUser || !selZone) ? 'opacity-50 cursor-not-allowed bg-gray-400' : 'bg-blue-600 hover:bg-blue-700 shadow-lg'" class="w-full text-white font-bold py-4 rounded-xl transition btn-act mb-8 text-xl">
                    é–‹å§‹ç›¤é»
                </button>

                <div class="grid grid-cols-2 gap-4">
                    <button @click="page='report'" class="bg-white border text-gray-700 font-bold py-4 rounded-xl shadow-sm hover:bg-gray-50 btn-act text-lg">ğŸ“Š å ±è¡¨ä¸­å¿ƒ</button>
                    <button @click="enterAdmin" class="bg-white border text-gray-700 font-bold py-4 rounded-xl shadow-sm hover:bg-gray-50 btn-act text-lg">âš™ï¸ è³‡æ–™ç¶­è­·</button>
                </div>
                <div class="text-center mt-8 text-xs text-gray-400">Total: {{ dbCount }} items</div>
            </div>
        </div>
    </div>

    <div v-else class="flex-1 flex flex-col h-full overflow-hidden bg-gray-100">
        <div class="bg-blue-600 p-4 text-white shadow-md z-10 shrink-0 flex flex-col gap-3">
            <div class="flex justify-between items-center">
                <div>
                    <div class="font-bold text-xl leading-tight">{{ selUser }}</div>
                    <div class="text-sm text-blue-200">{{ selZone }}</div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center text-xs bg-blue-700/80 px-2 py-1.5 rounded border border-blue-500">
                        <span class="dot" :class="isOnline ? 'dot-green' : 'dot-red'"></span>
                        {{ isOnline ? 'é€£ç·š' : 'æ–·ç·š' }}
                    </div>
                    <div v-if="isSaving" class="text-sm text-blue-200 animate-pulse">â˜ï¸...</div>
                    <div v-else class="text-sm text-green-300 font-bold">âœ”åŒæ­¥</div>
                    <button @click="page='home'" class="bg-blue-800 border border-blue-500 px-3 py-1.5 rounded text-sm hover:bg-blue-700 btn-act">é›¢é–‹</button>
                </div>
            </div>
            
            <div>
                <div class="flex justify-between text-xs text-blue-100 mb-1">
                    <span>å®Œæˆé€²åº¦</span>
                    <span>{{ currentProgress.done }}/{{ currentProgress.total }} ({{ currentProgress.pct }}%)</span>
                </div>
                <div class="w-full bg-blue-800 h-2.5 rounded-full overflow-hidden">
                    <div class="bg-green-400 h-full transition-all duration-300" :style="{width: currentProgress.pct+'%'}"></div>
                </div>
            </div>
            
            <div class="relative flex gap-2">
                <div class="relative flex-1">
                    <input v-model="keyword" type="text" placeholder="æœå°‹è—¥åã€ä»£ç¢¼..." class="w-full pl-10 pr-10 py-3 rounded-lg text-gray-800 text-base outline-none shadow-inner">
                    <div class="absolute left-3 top-3.5 text-gray-400 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                    <button v-if="keyword" @click="keyword=''" class="absolute right-3 top-3 text-gray-400 hover:text-red-500 text-lg font-bold">âœ•</button>
                </div>
                <button @click="openAddModal" class="bg-green-500 hover:bg-green-600 text-white font-bold px-4 rounded-lg shadow btn-act text-2xl flex items-center justify-center">ï¼‹</button>
            </div>

            <div class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-1">
                <button @click="showOnlyPending = !showOnlyPending" 
                        class="shrink-0 px-3 py-1.5 rounded-lg text-sm font-bold border transition-colors btn-act"
                        :class="showOnlyPending ? 'bg-yellow-400 text-yellow-900 border-yellow-500' : 'bg-blue-800/50 text-blue-100 border-blue-500'">
                    {{ showOnlyPending ? 'âš¡ åªçœ‹æœªç›¤' : 'é¡¯ç¤ºå…¨éƒ¨' }}
                </button>

                <div class="w-px h-6 bg-blue-400 shrink-0"></div>

                <button @click="resetFilters" 
                        class="shrink-0 px-3 py-1.5 rounded-lg text-sm font-bold border transition-colors btn-act"
                        :class="selGroup==='' ? 'bg-white text-blue-800 border-white' : 'bg-blue-800/50 text-blue-200 border-blue-500'">
                    å…¨éƒ¨æ«ƒä½
                </button>
                
                <button v-for="g in shelfGroups" :key="g" @click="selectGroup(g)" 
                        class="shrink-0 px-3 py-1.5 rounded-lg text-sm font-bold border transition-colors btn-act"
                        :class="selGroup===g ? 'bg-white text-blue-800 border-white' : 'bg-blue-800/50 text-blue-200 border-blue-500'">
                    {{ g }}
                </button>
            </div>

            <div v-if="selGroup" class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-1 pt-1 border-t border-blue-500/30">
                <span class="text-xs text-blue-200 font-bold shrink-0">è©³ç´°ä½ç½®:</span>
                <button v-for="s in currentSubShelves" :key="s" @click="selShelf=s"
                        class="shrink-0 px-3 py-1 rounded-full text-xs font-bold border transition-colors btn-act"
                        :class="selShelf===s ? 'bg-green-400 text-green-900 border-green-400' : 'bg-blue-900/50 text-blue-200 border-blue-400'">
                    {{ s }}
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-3 pb-32 custom-scroll">
            <div v-if="displayList.length === 0" class="flex flex-col items-center justify-center mt-20 text-gray-400">
                <div class="text-5xl mb-3">ğŸ“­</div>
                <p class="text-lg">æ‰¾ä¸åˆ°ç¬¦åˆçš„è—¥å“</p>
                <div v-if="showOnlyPending" class="text-sm mt-2 text-yellow-600">(å·²é–‹å•Ÿã€Œåªçœ‹æœªç›¤ã€ç¯©é¸)</div>
                <button @click="openAddModal" class="mt-4 text-blue-600 underline">æ–°å¢è—¥å“?</button>
            </div>

            <div v-for="item in displayList" :key="item.id" class="bg-white rounded-2xl shadow-sm mb-4 p-4 border-l-[8px] transition-all duration-300" 
                 :class="isDone(item) ? 'border-green-500 bg-green-50/50' : 'border-red-400'">
                
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1 mr-2">
                        <div class="font-extrabold text-gray-900 text-2xl leading-tight mb-1">{{ item.name }}</div>
                        <div class="text-sm text-gray-600 font-mono mt-1 flex items-center flex-wrap gap-2">
                            {{ item.code }} 
                            <span class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded font-bold">{{ item.shelf }}</span>
                        </div>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <span v-if="item.units?.lg?.cap > 0" class="text-sm px-2 py-1 bg-blue-100 border border-blue-200 rounded text-blue-800 font-bold">1{{ item.units.lg.name }}={{ item.units.lg.cap }}</span>
                            <span v-if="item.units?.sm?.cap > 1" class="text-sm px-2 py-1 bg-green-100 border border-green-200 rounded text-green-800 font-bold">1{{ item.units.sm.name }}={{ item.units.sm.cap }}</span>
                        </div>
                    </div>
                    
                    <div class="text-right min-w-[90px] flex flex-col items-end">
                        <div v-if="isDone(item)" class="flex flex-col items-end">
                            <div class="text-5xl font-bold text-green-600 leading-none">{{ calcTotal(item) }}</div>
                            <div class="text-xs text-gray-400 font-bold mt-1 bg-gray-50 px-2 py-0.5 rounded border border-gray-200">
                                {{ item.user || 'æœªçŸ¥' }}
                            </div>
                        </div>
                        <div v-else class="text-xl font-bold text-red-400 animate-pulse bg-red-50 px-3 py-1 rounded">æœªç›¤</div>
                        <button v-if="!isDone(item)" @click="setZero(item)" class="text-sm mt-3 bg-gray-500 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-600 btn-act w-full">ğŸ—‘ï¸ ç„¡åº«å­˜</button>
                    </div>
                </div>

                <div v-if="expiryZones.includes(item.zone)" class="bg-gray-50 p-2 rounded-xl border border-gray-200">
                     <label class="block text-gray-600 font-bold mb-2 ml-1">ğŸ“¦ æ‰¹è™Ÿèˆ‡æ•ˆæœŸç®¡ç†</label>
                     <div v-for="(batch, idx) in item.batches" :key="idx" class="flex gap-2 mb-2 items-center">
                        <div class="flex-1">
                            <input type="date" v-model="batch.expiry" @change="save(item)" class="w-full h-12 rounded-lg border border-gray-300 text-center text-lg shadow-sm">
                        </div>
                        <div class="w-24">
                            <input type="number" v-model.number="batch.qty" @input="save(item)" @focus="$event.target.select()" class="w-full h-12 rounded-lg border border-gray-300 text-center text-xl font-bold shadow-sm" placeholder="æ•¸é‡">
                        </div>
                        <button @click="removeBatch(item, idx)" class="w-10 h-12 bg-red-100 text-red-500 rounded-lg font-bold border border-red-200">âœ•</button>
                     </div>
                     <button @click="addBatch(item)" class="w-full py-3 bg-green-100 text-green-700 font-bold rounded-lg border-2 border-dashed border-green-300 hover:bg-green-200 btn-act">ï¼‹ æ–°å¢ä¸€ç­†æ•ˆæœŸ</button>
                </div>

                <div v-else class="grid grid-cols-3 gap-3">
                    <div v-if="item.units?.lg?.cap > 0" 
                         class="p-1 rounded-xl border-2 border-blue-200 bg-blue-50 flex flex-col items-center"
                         @click="$event.currentTarget.querySelector('input').focus()">
                        <label class="text-base text-blue-900 mb-1 font-bold">{{ item.units.lg.name }}</label>
                        <input type="number" inputmode="numeric" pattern="[0-9]*" 
                               v-model.number="item.inputs.lg" @input="save(item)" @focus="$event.target.select()" 
                               class="w-full h-16 rounded-lg text-center text-3xl font-black outline-none shadow-inner transition-colors p-0 border-4"
                               :class="item.inputs.lg !== 0 ? 'bg-blue-100 border-blue-600 text-blue-800' : 'bg-white border-gray-300 text-gray-900 focus:border-blue-500'"
                               placeholder="0">
                    </div>
                    <div v-else class="flex justify-center items-center opacity-10 text-sm bg-gray-50 rounded-lg">-</div>

                    <div v-if="item.units?.sm?.cap > 1" 
                         class="p-1 rounded-xl border-2 border-green-200 bg-green-50 flex flex-col items-center"
                         @click="$event.currentTarget.querySelector('input').focus()">
                        <label class="text-base text-green-900 mb-1 font-bold">{{ item.units.sm.name }}</label>
                        <input type="number" inputmode="numeric" pattern="[0-9]*" 
                               v-model.number="item.inputs.sm" @input="save(item)" @focus="$event.target.select()" 
                               class="w-full h-16 rounded-lg text-center text-3xl font-black outline-none shadow-inner transition-colors p-0 border-4"
                               :class="item.inputs.sm !== 0 ? 'bg-green-100 border-green-600 text-green-800' : 'bg-white border-gray-300 text-gray-900 focus:border-green-500'"
                               placeholder="0">
                    </div>
                    <div v-else class="flex justify-center items-center opacity-10 text-sm bg-gray-50 rounded-lg">-</div>

                    <div class="p-1 rounded-xl border-2 border-orange-200 bg-orange-50 flex flex-col items-center"
                         @click="$event.currentTarget.querySelector('input').focus()">
                        <label class="text-base text-orange-900 mb-1 font-bold">{{ item.units.lo?.name || 'é¡†/æ”¯' }}</label>
                        <input type="number" inputmode="numeric" pattern="[0-9]*" 
                               v-model.number="item.inputs.lo" @input="save(item)" @focus="$event.target.select()" 
                               class="w-full h-16 rounded-lg text-center text-2xl font-black outline-none shadow-inner transition-colors p-0 border-4"
                               :class="item.inputs.lo !== 0 ? 'bg-orange-100 border-orange-600 text-orange-800' : 'bg-white border-gray-300 text-gray-900 focus:border-orange-500'"
                               placeholder="0">
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div v-if="showAddModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop" @click.self="showAddModal=false">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl overflow-hidden animate-bounce-in">
            <div class="bg-green-600 p-4 text-white font-bold text-xl flex justify-between items-center">
                <span>â• ç¾å ´è£œå–®</span>
                <button @click="showAddModal=false" class="text-white hover:text-red-200">âœ•</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-gray-700 font-bold mb-1">è—¥å“ä»£ç¢¼ <span class="text-red-500">*</span></label>
                    <input v-model="newItem.code" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-green-500 outline-none" placeholder="ä¾‹å¦‚: XYZ123">
                </div>
                <div>
                    <label class="block text-gray-700 font-bold mb-1">è—¥å“åç¨± <span class="text-red-500">*</span></label>
                    <input v-model="newItem.name" type="text" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-green-500 outline-none" placeholder="ä¾‹å¦‚: Panadol">
                </div>
                
                <div class="grid grid-cols-2 gap-4 bg-gray-50 p-3 rounded-lg">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">å¤§åŒ…è£é‡ (ç›’)</label>
                        <input v-model.number="newItem.lgCap" type="number" class="w-full p-2 border rounded text-center">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">å°åŒ…è£é‡ (æ’)</label>
                        <input v-model.number="newItem.smCap" type="number" class="w-full p-2 border rounded text-center">
                    </div>
                </div>

                <button @click="confirmAdd" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg hover:bg-green-700 btn-act">ç¢ºèªæ–°å¢</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
    window.onerror = function(msg, url, line) {
        const el = document.getElementById('crash-log');
        el.style.display = 'block';
        el.innerHTML += `âŒ ${msg} (Line: ${line})<br>`;
        return false;
    };

    import { createApp, ref, computed, onMounted, watch } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDZuNztwb9aLG1RqeDOyrj6KJrPhwBFi9M",
      authDomain: "fyh-pharmacy-inventory.firebaseapp.com",
      databaseURL: "https://fyh-pharmacy-inventory-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "fyh-pharmacy-inventory",
      storageBucket: "fyh-pharmacy-inventory.firebasestorage.app",
      messagingSenderId: "751378148626",
      appId: "1:751378148626:web:5a2d2be1c5f905657457cb",
      measurementId: "G-0X63VL8KMR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            const page = ref('home');
            const isOnline = ref(false);
            const isSaving = ref(false);
            const isUploading = ref(false);
            const staffList = ref([]);
            const inventory = ref([]);
            const selUser = ref('');
            const selZone = ref('');
            const keyword = ref('');
            
            // Filters
            const showOnlyPending = ref(false);
            const selGroup = ref(''); // Level 1: Main Group (e.g. A, èª¿A)
            const selShelf = ref(''); // Level 2: Specific Shelf (e.g. A1, èª¿A2)

            // Add Modal State
            const showAddModal = ref(false);
            const newItem = ref({ code: '', name: '', lgCap: 0, smCap: 0 });

            // Special Zones
            const expiryZones = ['é»æ»´ER', 'é»æ»´OPD'];

            onMounted(() => {
                onValue(dbRef(db, ".info/connected"), s => isOnline.value = s.val());
                onValue(dbRef(db, "staff"), s => staffList.value = s.val() || []);
                onValue(dbRef(db, "inventory"), s => {
                    const data = s.val();
                    if (!data) { inventory.value = []; return; }
                    const arr = Array.isArray(data) ? data : Object.values(data);
                    
                    inventory.value = arr.map(item => {
                        if (!item) return null;
                        if (!item.inputs) item.inputs = { lg: 0, sm: 0, lo: 0 };
                        if (!item.units) item.units = {};
                        
                        if (!item.units.lg) item.units.lg = { cap: 0, name: 'ç›’' };
                        if (!item.units.sm) item.units.sm = { cap: 0, name: 'æ’' };
                        if (!item.units.lo) item.units.lo = { name: 'é¡†/æ”¯' };
                        
                        if (item.done === undefined) item.done = false;
                        if (!item.user) item.user = '';
                        if (!item.code) item.code = '???';
                        if (!item.name) item.name = 'æœªçŸ¥è—¥å“';
                        
                        if (!item.batches) item.batches = [{ expiry: '', qty: 0 }];

                        return item;
                    }).filter(x => x !== null);
                });
            });

            // Watch zone change to reset all filters
            watch(selZone, () => {
                resetFilters();
            });

            const resetFilters = () => {
                selGroup.value = '';
                selShelf.value = '';
                showOnlyPending.value = false;
                keyword.value = '';
            };

            const selectGroup = (g) => {
                selGroup.value = g;
                selShelf.value = ''; // Reset level 2
            };

            const dbCount = computed(() => inventory.value.length);
            const staffCount = computed(() => staffList.value.length);
            const zoneList = computed(() => [...new Set(inventory.value.map(i => i.zone))].sort());
            
            // Computed: Groups (Level 1)
            // Logic: Extract Prefix from Shelf Name (e.g., "A1" -> "A", "èª¿A1" -> "èª¿A")
            const shelfGroups = computed(() => {
                const items = inventory.value.filter(i => i.zone === selZone.value && i.shelf);
                const groups = new Set();
                items.forEach(i => {
                    // Regex: Match non-digit prefix. e.g. "A1" -> "A", "èª¿A1" -> "èª¿A"
                    // If no match (e.g. "123"), treat as "å…¶ä»–"
                    const match = i.shelf.match(/^([^\d]+)/); 
                    if (match) groups.add(match[1]);
                    else groups.add('å…¶ä»–');
                });
                return Array.from(groups).sort();
            });

            // Computed: Sub Shelves (Level 2)
            // Shows only shelves belonging to the selected Group
            const currentSubShelves = computed(() => {
                if (!selGroup.value) return [];
                const items = inventory.value.filter(i => i.zone === selZone.value);
                const shelves = new Set();
                
                items.forEach(i => {
                    const match = i.shelf ? i.shelf.match(/^([^\d]+)/) : null;
                    const group = match ? match[1] : 'å…¶ä»–';
                    if (group === selGroup.value) {
                        shelves.add(i.shelf);
                    }
                });
                return Array.from(shelves).sort();
            });

            const displayList = computed(() => {
                if (!selZone.value) return [];
                let list = inventory.value.filter(i => i.zone === selZone.value);
                
                // 1. Keyword Filter
                if (keyword.value) {
                    const k = keyword.value.trim().toLowerCase();
                    list = list.filter(i => 
                        (i.name && i.name.toLowerCase().includes(k)) || 
                        (i.code && i.code.toLowerCase().includes(k))
                    );
                }

                // 2. Hierarchy Filter (Group > Shelf)
                if (selShelf.value) {
                    // Exact shelf match (Level 2 selected)
                    list = list.filter(i => i.shelf === selShelf.value);
                } else if (selGroup.value) {
                    // Group match (Level 1 selected)
                    list = list.filter(i => {
                        const match = i.shelf ? i.shelf.match(/^([^\d]+)/) : null;
                        const group = match ? match[1] : 'å…¶ä»–';
                        return group === selGroup.value;
                    });
                }

                // 3. Pending Filter
                if (showOnlyPending.value) {
                    list = list.filter(i => !isDone(i));
                }

                return list;
            });

            const currentProgress = computed(() => {
                const list = inventory.value.filter(i => i.zone === selZone.value);
                const total = list.length;
                if (total === 0) return { total: 0, done: 0, pct: 0 };
                const done = list.filter(isDone).length;
                return { total, done, pct: Math.round((done/total)*100) };
            });

            const zoneStats = computed(() => {
                const stats = {};
                zoneList.value.forEach(z => stats[z] = { name: z, total: 0, done: 0 });
                inventory.value.forEach(i => {
                    if (stats[i.zone]) {
                        stats[i.zone].total++;
                        if (isDone(i)) stats[i.zone].done++;
                    }
                });
                return Object.values(stats).map(s => ({
                    ...s, pct: s.total===0 ? 0 : Math.round((s.done/s.total)*100)
                }));
            });

            const isDone = (item) => {
                if (expiryZones.includes(item.zone)) {
                    const total = item.batches.reduce((acc, cur) => acc + cur.qty, 0);
                    return total > 0 || item.done;
                }
                return (item.inputs.lg !== 0 || item.inputs.sm !== 0 || item.inputs.lo !== 0 || item.done);
            };
            
            const calcTotal = (item) => {
                if (expiryZones.includes(item.zone)) {
                    return item.batches.reduce((acc, cur) => acc + cur.qty, 0);
                }
                const lg = item.units?.lg?.cap || 0;
                const sm = item.units?.sm?.cap || 0;
                return (item.inputs.lg * lg) + (item.inputs.sm * sm) + item.inputs.lo;
            };

            const startInv = () => { if (selUser.value && selZone.value) page.value = 'work'; };
            const enterAdmin = () => { if (prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼") === "8888") page.value = 'admin'; };
            
            let timerMap = {};
            const save = (item) => {
                isSaving.value = true;
                item.done = true;
                item.user = selUser.value;
                item.time = new Date().toISOString();
                const idx = inventory.value.findIndex(x => x.id === item.id);
                if (idx === -1) return;
                clearTimeout(timerMap[item.id]);
                timerMap[item.id] = setTimeout(() => {
                    update(dbRef(db, `inventory/${idx}`), {
                        inputs: item.inputs,
                        user: item.user,
                        time: item.time,
                        done: true,
                        batches: item.batches
                    }).then(() => isSaving.value = false).catch(e => console.error(e));
                }, 500);
            };

            const setZero = (item) => {
                if (expiryZones.includes(item.zone)) {
                    item.batches = [{ expiry: '', qty: 0 }];
                } else {
                    item.inputs.lg = 0; item.inputs.sm = 0; item.inputs.lo = 0;
                }
                save(item);
            };
            
            const addBatch = (item) => {
                item.batches.push({ expiry: '', qty: 0 });
                save(item); 
            };

            const removeBatch = (item, idx) => {
                if (item.batches.length > 1) {
                    item.batches.splice(idx, 1);
                    save(item);
                } else {
                    item.batches[0].qty = 0;
                    item.batches[0].expiry = '';
                    save(item);
                }
            };

            const resetDatabase = () => {
                if(confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
                    set(dbRef(db, "inventory"), null);
                    set(dbRef(db, "staff"), null);
                    alert("å·²é‡ç½®è³‡æ–™åº«");
                }
            };

            const openAddModal = () => {
                newItem.value = { code: '', name: '', lgCap: 0, smCap: 0 };
                showAddModal.value = true;
            };

            const confirmAdd = () => {
                if (!newItem.value.code || !newItem.value.name) {
                    alert("è«‹å¡«å¯«ä»£ç¢¼èˆ‡åç¨±"); return;
                }
                const newIdx = inventory.value.length;
                const itemData = {
                    id: `${selZone.value}_${newItem.value.code}_MANUAL`,
                    code: newItem.value.code,
                    name: newItem.value.name,
                    zone: selZone.value,
                    shelf: 'æ‰‹å‹•',
                    units: {
                        lg: { cap: newItem.value.lgCap, name: 'ç›’' },
                        sm: { cap: newItem.value.smCap, name: 'æ’' },
                        lo: { name: 'é¡†/æ”¯' }
                    },
                    inputs: { lg: 0, sm: 0, lo: 0 },
                    done: false,
                    user: selUser.value,
                    time: new Date().toISOString(),
                    batches: [{ expiry: '', qty: 0 }]
                };
                
                update(dbRef(db, `inventory/${newIdx}`), itemData)
                    .then(() => {
                        alert("æ–°å¢æˆåŠŸï¼");
                        showAddModal.value = false;
                        keyword.value = newItem.value.code; 
                    });
            };

            const uploadStaff = (e) => {
                const f = e.target.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = (evt) => {
                    const txt = evt.target.result.replace(/\r\n/g, ',').replace(/\n/g, ',');
                    const arr = txt.split(',').map(x => x.trim()).filter(x => x);
                    if (arr.length > 0) {
                        set(dbRef(db, "staff"), arr);
                        alert(`å·²åŒ¯å…¥ ${arr.length} ä½äººå“¡`);
                    }
                };
                r.readAsText(f);
            };

            const uploadInventory = async (e) => {
                const files = e.target.files;
                if (!files.length) return;
                isUploading.value = true;
                try {
                    let allItems = [];
                    for (let i=0; i<files.length; i++) {
                        const file = files[i];
                        let zName = file.name.replace(/\.(csv|xlsx|xls)$/, '');
                        const m = zName.match(/[-_]\s*(.+)/); 
                        if (m) zName = m[1].trim();
                        const items = await parseFile(file, zName);
                        allItems = allItems.concat(items);
                    }
                    if (allItems.length > 0) {
                        if (confirm(`æº–å‚™è¦†è“‹ä¸Šå‚³ ${allItems.length} ç­†è—¥å“ï¼Ÿ`)) {
                            const cleanData = JSON.parse(JSON.stringify(allItems));
                            await set(dbRef(db, "inventory"), cleanData);
                            alert("ä¸Šå‚³æˆåŠŸï¼");
                        }
                    } else { alert("è®€å–å¤±æ•—"); }
                } catch(err) { alert("ä¸Šå‚³éŒ¯èª¤: " + err); }
                isUploading.value = false;
            };

            const parseFile = (file, zone) => {
                return new Promise(resolve => {
                    const r = new FileReader();
                    r.onload = (e) => {
                        try {
                            const wb = XLSX.read(e.target.result, { type: 'binary' });
                            const sheet = wb.Sheets[wb.SheetNames[0]];
                            const rows = XLSX.utils.sheet_to_json(sheet, { header:1, defval:'' });
                            
                            let headIdx = -1;
                            for(let r=0; r<Math.min(rows.length, 20); r++) {
                                const str = rows[r].join(' ');
                                if (str.includes('ä»£ç¢¼') || str.toLowerCase().includes('code')) { headIdx = r; break; }
                            }
                            if (headIdx === -1) headIdx = 0;
                            
                            const clean = (s) => String(s).replace(/[\(\)\/\s]/g, '');
                            const header = rows[headIdx].map(x => String(x).trim());
                            
                            const idxMap = {
                                code: header.findIndex(x => x.includes('ä»£ç¢¼') || x.toLowerCase().includes('code')),
                                name: header.findIndex(x => x.includes('åç¨±') || x.toLowerCase().includes('name')),
                                shelf: header.findIndex(x => x.includes('å„²ä½') || x.includes('é–€ç‰Œ')),
                                lgCap: header.findIndex(x => { const c = clean(x); return c.includes('å¤§åŒ…è£') && c.includes('é‡'); }),
                                lgUnit: header.findIndex(x => { const c = clean(x); return c.includes('å¤§åŒ…è£') && (c.includes('å–®ä½') || c.includes('unit')); }),
                                smCap: header.findIndex(x => { const c = clean(x); return c.includes('å°åŒ…è£') && c.includes('é‡'); }),
                                smUnit: header.findIndex(x => { const c = clean(x); return c.includes('å°åŒ…è£') && (c.includes('å–®ä½') || c.includes('unit')); }),
                            };
                            
                            if (idxMap.code === -1) {
                                idxMap.code=0; idxMap.name=1; idxMap.shelf=3;
                                idxMap.lgCap=4; idxMap.lgUnit=5;
                                idxMap.smCap=6; idxMap.smUnit=7;
                            }
                            
                            const parsed = [];
                            for(let r=headIdx+1; r<rows.length; r++) {
                                const row = rows[r];
                                const code = row[idxMap.code] ? String(row[idxMap.code]).trim() : '';
                                if (!code) continue;
                                
                                let lgCap = parseInt(row[idxMap.lgCap]) || 0;
                                let lgName = row[idxMap.lgUnit] ? String(row[idxMap.lgUnit]).replace(/[\/x]/g,'').trim() : 'ç›’';
                                let smCap = parseInt(row[idxMap.smCap]);
                                if (isNaN(smCap)) smCap = 0; 
                                let smName = row[idxMap.smUnit] ? String(row[idxMap.smUnit]).replace(/[\/x]/g,'').trim() : '';
                                let loName = 'é¡†/æ”¯'; 
                                if (smCap <= 1) {
                                    if (smName) loName = smName; 
                                    smCap = 0; 
                                    smName = ''; 
                                } else {
                                    if (!smName) smName = 'æ’';
                                }
                                if (!isNaN(parseFloat(lgName)) || lgName.length > 5) lgName = 'ç›’';

                                parsed.push({
                                    id: `${zone}_${code}_${r}`,
                                    code,
                                    name: row[idxMap.name] || 'ç„¡å“å',
                                    shelf: row[idxMap.shelf] || '',
                                    zone,
                                    units: { 
                                        lg: { cap: lgCap, name: lgName }, 
                                        sm: { cap: smCap, name: smName },
                                        lo: { name: loName } 
                                    },
                                    inputs: { lg: 0, sm: 0, lo: 0 },
                                    done: false,
                                    batches: [{ expiry: '', qty: 0 }] 
                                });
                            }
                            resolve(parsed);
                        } catch(err) { resolve([]); }
                    };
                    r.readAsBinaryString(file);
                });
            };

            const exportZone = (z) => {
                const data = inventory.value.filter(x => x.zone === z).map(x => {
                    let qtyStr = '';
                    let expiryStr = '';
                    
                    if (expiryZones.includes(x.zone)) {
                        const validBatches = x.batches.filter(b => b.qty > 0);
                        if (validBatches.length > 0) {
                            qtyStr = validBatches.map(b => `${b.qty}`).join(', ');
                            expiryStr = validBatches.map(b => b.expiry || 'ç„¡æ•ˆæœŸ').join(', ');
                        } else {
                            qtyStr = '0';
                        }
                    } else {
                        qtyStr = isDone(x) ? `${x.inputs.lg}${x.units?.lg?.name} ${x.inputs.sm}${x.units?.sm?.name} ${x.inputs.lo.name}`.trim() : 'æœªç›¤';
                    }

                    return {
                        'ä»£ç¢¼': x.code, 'åç¨±': x.name, 'å„²ä½': x.shelf,
                        'ç›¤é»é‡': qtyStr,
                        'ç¸½é‡': isDone(x) ? calcTotal(x) : 0, 
                        'æ•ˆæœŸ': expiryStr,
                        'ç›¤é»äºº': x.user || '',
                        'æ™‚é–“': x.time ? new Date(x.time).toLocaleString() : ''
                    };
                });
                dlExcel(data, `ç›¤é»_${z}`);
            };

            const exportTotal = () => {
                const map = {};
                inventory.value.forEach(x => {
                    if (!map[x.code]) map[x.code] = { code:x.code, name:x.name, total:0, expiry:'' };
                    if (isDone(x)) {
                        const t = calcTotal(x);
                        map[x.code][x.zone] = t; 
                        map[x.code].total += t;
                        
                        if (expiryZones.includes(x.zone)) {
                             const exps = x.batches.filter(b=>b.qty>0 && b.expiry).map(b=>b.expiry).join(',');
                             if(exps) map[x.code].expiry = exps;
                        }
                    }
                });
                dlExcel(Object.values(map), 'å…¨é™¢ç¸½è¡¨');
            };

            const dlExcel = (json, fname) => {
                const ws = XLSX.utils.json_to_sheet(json);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                XLSX.writeFile(wb, `${fname}.xlsx`);
            };

            return {
                page, isOnline, isSaving, isUploading,
                selUser, selZone, keyword,
                staffList, dbCount, staffCount, zoneList, displayList, currentProgress, zoneStats,
                startInv, enterAdmin, resetDatabase, uploadStaff, uploadInventory,
                save, setZero, isDone, calcTotal, exportZone, exportTotal,
                showAddModal, newItem, openAddModal, confirmAdd,
                expiryZones, addBatch, removeBatch,
                showOnlyPending, selShelf, selGroup, shelfGroups, currentSubShelves, resetFilters, selectGroup
            };
        }
    }).mount('#app');
</script>
</body>
</html>
