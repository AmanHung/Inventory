<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è—¥å±€ç›¤é»ç³»çµ± v4.0 (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
  apiKey: "AIzaSyDZuNztwb9aLG1RqeDOyrj6KJrPhwBFi9M",
  authDomain: "fyh-pharmacy-inventory.firebaseapp.com",
  databaseURL: "https://fyh-pharmacy-inventory-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "fyh-pharmacy-inventory",
  storageBucket: "fyh-pharmacy-inventory.firebasestorage.app",
  messagingSenderId: "751378148626",
  appId: "1:751378148626:web:5a2d2be1c5f905657457cb",
  measurementId: "G-0X63VL8KMR"
};

        // åˆå§‹åŒ– Firebase
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            window.firebaseDb = db; // æ›è¼‰åˆ° window è®“ Vue å¯ä»¥å­˜å–
            window.firebaseRef = ref;
            window.firebaseSet = set;
            window.firebaseOnValue = onValue;
            window.firebaseUpdate = update;
            window.firebaseRemove = remove;
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("Firebase init error:", e);
            alert("Firebase é€£ç·šå¤±æ•—ï¼è«‹ç¢ºèªç¨‹å¼ç¢¼ä¸­çš„ firebaseConfig æ˜¯å¦å·²æ­£ç¢ºå¡«å¯«ã€‚");
        }
    </script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Segoe UI", Roboto, sans-serif; background-color: #f3f4f6; }
        .input-box { @apply w-full h-10 border border-gray-400 rounded mx-1 text-center text-lg font-bold outline-none transition-colors p-0; min-width: 40px; -moz-appearance: textfield; }
        .input-box:focus { @apply ring-2 ring-blue-500 border-blue-500 bg-blue-50; }
        .input-box::-webkit-outer-spin-button, .input-box::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .input-empty { @apply bg-white text-red-500 placeholder-red-300; }
        .input-filled { @apply bg-blue-50 text-black border-blue-300; }
        .btn-unit { @apply flex-shrink-0 w-10 h-10 flex items-center justify-center bg-gray-200 rounded font-bold text-xl text-gray-600 active:scale-95 select-none cursor-pointer hover:bg-gray-300 shadow-sm border border-gray-300; }
        .btn-zero { @apply mt-auto w-full text-xs bg-gray-600 text-white py-2 rounded shadow hover:bg-gray-700 active:bg-gray-800 active:scale-95 transition font-bold tracking-wide flex items-center justify-center gap-1; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* é€£ç·šç‹€æ…‹ç‡ˆ */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .status-offline { background-color: #ef4444; }
    </style>
</head>
<body>

<div id="app" class="w-full max-w-md mx-auto min-h-screen bg-white shadow-xl flex flex-col border-x border-gray-200 relative">

    <div class="absolute top-2 right-2 z-50 text-xs font-bold px-2 py-1 rounded bg-white/80 backdrop-blur border shadow-sm flex items-center">
        <span class="status-dot" :class="isOnline ? 'status-online' : 'status-offline'"></span>
        {{ isOnline ? 'é›²ç«¯é€£ç·šä¸­' : 'æ–·ç·š' }}
    </div>

    <div v-if="currentPage === 'admin'" class="flex-1 flex flex-col p-6 bg-gray-50 overflow-y-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            <span class="text-blue-600">âš™ï¸</span> è³‡æ–™ç¶­è­· (é›²ç«¯ç‰ˆ)
        </h2>

        <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-indigo-500">
            <h3 class="font-bold text-lg mb-2 text-indigo-900">1. äººå“¡åå–®ç®¡ç†</h3>
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-bold text-gray-700">é›²ç«¯åå–®: {{ staffList.length }} ä½</span>
                <button v-if="staffList.length > 0" @click="clearStaff" class="text-xs text-red-500 underline">æ¸…ç©ºé›²ç«¯</button>
            </div>
            <input type="file" ref="staffInput" accept=".csv,.txt" @change="handleStaffUpload" class="hidden">
            <button @click="$refs.staffInput.click()" class="w-full bg-indigo-100 text-indigo-700 font-bold py-2 rounded border border-indigo-200 hover:bg-indigo-200 transition">
                ğŸ‘¤ ä¸Šå‚³äººå“¡è‡³é›²ç«¯
            </button>
        </div>

        <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-blue-500">
            <h3 class="font-bold text-lg mb-2 text-blue-900">2. è—¥å“ç›¤é»è¡¨ç®¡ç†</h3>
            <p class="text-xs text-gray-500 mb-3 text-red-600">æ³¨æ„ï¼šé‡æ–°ä¸Šå‚³å°‡æœƒè¦†è“‹é›²ç«¯ç¾æœ‰çš„ç›¤é»è³‡æ–™ï¼</p>
            
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-bold text-gray-700">é›²ç«¯è—¥å“: {{ inventory.length }} ç­†</span>
                <button v-if="inventory.length > 0" @click="clearInventory" class="text-xs text-red-500 underline">æ¸…ç©ºé›²ç«¯</button>
            </div>
            <input type="file" ref="fileInput" multiple accept=".csv,.xlsx,.xls" @change="handleFileUpload" class="hidden">
            <button @click="$refs.fileInput.click()" class="w-full bg-blue-100 text-blue-700 font-bold py-3 rounded-lg border border-blue-300 hover:bg-blue-200 transition mb-2">
                ğŸ“‚ ä¸Šå‚³ç›¤é»è¡¨è‡³é›²ç«¯
            </button>
            
            <div v-if="isProcessing" class="flex items-center justify-center gap-3 py-4 text-gray-600">
                <div class="loader"></div> ä¸Šå‚³ä¸­...
            </div>
        </div>
        <button @click="currentPage = 'login'" class="mt-auto w-full bg-gray-600 text-white font-bold py-3 rounded-lg shadow hover:bg-gray-700">è¿”å›é¦–é </button>
    </div>

    <div v-else-if="currentPage === 'report'" class="flex-1 flex flex-col p-6 bg-gray-50 overflow-y-auto">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
            <span class="text-green-600">ğŸ“Š</span> å ±è¡¨ä¸­å¿ƒ (å³æ™‚)
        </h2>

        <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-blue-600">
            <h3 class="font-bold text-lg mb-3 flex justify-between items-center">
                å³æ™‚é€²åº¦ç›£æ§
                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">å…± {{ uniqueZones.length }} å€</span>
            </h3>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2 custom-scroll">
                <div v-for="z in zoneProgress" :key="z.name" class="w-full bg-gray-50 p-3 rounded border border-gray-100">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-800 text-sm">{{ z.name }}</span>
                            <span class="text-xs font-mono" :class="{'text-green-600 font-bold': z.percent === 100, 'text-gray-500': z.percent < 100}">
                                {{ z.done }}/{{ z.total }} ({{ z.percent }}%)
                            </span>
                        </div>
                        <button @click="exportZone(z.name)" 
                            class="text-xs font-bold px-3 py-1.5 rounded transition-colors shadow-sm border flex items-center gap-1"
                            :class="z.percent === 100 ? 'bg-green-100 text-green-800 border-green-300 hover:bg-green-200' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-100'">
                            <span v-if="z.percent === 100">âœ…</span><span v-else>ğŸ“¥</span> åŒ¯å‡º
                        </button>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all duration-500" :class="{ 'bg-red-500': z.percent < 50, 'bg-yellow-400': z.percent >= 50 && z.percent < 100, 'bg-green-500': z.percent === 100 }" :style="{ width: z.percent + '%' }"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white p-4 rounded-lg shadow mb-6 border-l-4 border-purple-500">
            <h3 class="font-bold text-lg mb-2">åº«å­˜ç¸½è¡¨</h3>
            <button @click="exportMasterPivotReport" class="w-full bg-purple-600 text-white font-bold py-2 rounded hover:bg-purple-700 shadow">åŒ¯å‡ºå…¨é™¢ç¸½è¡¨</button>
        </div>
        <button @click="currentPage = 'login'" class="mt-auto w-full bg-gray-600 text-white font-bold py-3 rounded-lg shadow hover:bg-gray-700">è¿”å›é¦–é </button>
    </div>

    <div v-else-if="currentPage === 'login'" class="flex-1 flex flex-col justify-center items-center p-8 bg-blue-50">
        <div class="w-full max-w-sm">
            <h1 class="text-3xl font-bold text-blue-800 text-center mb-1">è—¥å±€ç›¤é»ç³»çµ±</h1>
            <p class="text-center text-gray-400 text-sm mb-8">v4.0 (Firebaseé›²ç«¯åŒæ­¥ç‰ˆ)</p>
            
            <div v-if="!isOnline" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded">
                <p class="font-bold">âš ï¸ é€£ç·šä¸­æ–·</p>
                <p class="text-sm">æ­£åœ¨å˜—è©¦é€£ç·šè‡³è³‡æ–™åº«...</p>
            </div>

            <div v-if="isOnline && inventory.length === 0" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded shadow-sm">
                <p class="font-bold">âš ï¸ è³‡æ–™åº«æ˜¯ç©ºçš„</p>
                <p class="text-sm">è«‹ç®¡ç†å“¡é»æ“Šä¸‹æ–¹ã€Œè³‡æ–™ç¶­è­·ã€é€²è¡Œåˆå§‹åŒ¯å…¥ã€‚</p>
            </div>
            
            <div v-if="inventory.length > 0 && staffList.length > 0">
                <label class="block text-gray-700 text-sm font-bold mb-2">1. ç›¤é»äººå“¡</label>
                <select v-model="currentUser" class="w-full p-3 border rounded-lg bg-white shadow-sm text-lg mb-4 cursor-pointer hover:border-blue-500">
                    <option disabled value="">-- è«‹é¸æ“‡ --</option>
                    <option v-for="name in staffList" :value="name">{{ name }}</option>
                </select>

                <label class="block text-gray-700 text-sm font-bold mb-2">2. ç›¤é»å€åŸŸ</label>
                <select v-model="currentZone" class="w-full p-3 border rounded-lg bg-white shadow-sm text-lg mb-6 cursor-pointer hover:border-blue-500">
                    <option disabled value="">-- è«‹é¸æ“‡ --</option>
                    <option v-for="zone in uniqueZones" :value="zone">{{ zone }}</option>
                </select>

                <button @click="enterSystem" 
                    :disabled="!currentUser || !currentZone"
                    :class="{'opacity-50 cursor-not-allowed': !currentUser || !currentZone}"
                    class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow hover:bg-blue-700 transition text-lg mb-6">
                    é–‹å§‹ç›¤é»
                </button>

                <hr class="border-gray-300 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <button @click="currentPage = 'report'" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 rounded shadow hover:bg-gray-50 flex flex-col items-center">
                        <span class="text-2xl mb-1">ğŸ“Š</span> å ±è¡¨ä¸­å¿ƒ
                    </button>
                    <button @click="enterAdmin" class="bg-white border border-gray-300 text-gray-700 font-bold py-2 rounded shadow hover:bg-gray-50 flex flex-col items-center">
                        <span class="text-2xl mb-1">âš™ï¸</span> è³‡æ–™ç¶­è­·
                    </button>
                </div>
            </div>
            
            <button v-if="isOnline && (inventory.length === 0 || staffList.length === 0)" @click="enterAdmin" class="mt-4 text-blue-600 underline font-bold">å‰å¾€åŒ¯å…¥è³‡æ–™ ></button>
        </div>
    </div>

    <div v-else class="flex-1 flex flex-col h-screen overflow-hidden">
        <div class="bg-blue-700 p-3 text-white shadow-md z-20 shrink-0">
            <div class="flex justify-between items-center mb-2">
                <div class="flex flex-col overflow-hidden">
                    <span class="font-bold text-lg truncate">{{ currentUser }}</span>
                    <span class="text-xs text-blue-200 truncate">å€åŸŸ: {{ currentZone }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span v-if="isSaving" class="text-xs text-blue-200 animate-pulse">â˜ï¸ åŒæ­¥ä¸­...</span>
                    <span v-else class="text-xs text-green-300">âœ” å·²åŒæ­¥</span>
                    <button @click="exitCounting" class="text-xs font-bold px-3 py-2 rounded bg-blue-800 border border-blue-500 hover:bg-blue-600 transition shadow">
                        é›¢é–‹
                    </button>
                </div>
            </div>
            
            <div class="flex justify-between items-end text-xs text-blue-100 mb-1 px-1">
                <span class="font-bold">å€åŸŸé€²åº¦</span>
                <span class="font-mono">{{ currentZoneStats.done }}/{{ currentZoneStats.total }} ({{ currentZoneStats.percent }}%)</span>
            </div>
            <div class="w-full bg-blue-900 rounded-full h-2.5 mb-3 overflow-hidden border border-blue-600">
                <div class="bg-green-400 h-2.5 rounded-full transition-all duration-500" :style="{ width: progressPercent + '%' }"></div>
            </div>
            <div class="relative">
                <input v-model="searchQuery" type="text" placeholder="ğŸ” æœå°‹è—¥åã€ä»£ç¢¼..." class="w-full px-3 py-2 rounded text-gray-800 outline-none shadow-inner focus:ring-2 focus:ring-blue-400">
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2 bg-gray-100 pb-20 no-scrollbar">
            <div v-for="item in filteredInventory" :key="item.id" 
                 class="rounded-lg shadow mb-3 p-3 border-l-[6px] border transition-all duration-200 bg-white"
                 :class="isItemComplete(item) ? 'border-green-500 border-l-green-600 bg-green-50/30' : 'border-red-300 border-l-red-500 bg-red-50/30'">
                
                <div class="flex justify-between items-start mb-3 gap-2">
                    <div class="flex-1 min-w-0"> 
                        <div class="font-bold text-lg text-gray-800 leading-tight break-words">{{ item.name }}</div>
                        <div class="text-xs text-gray-500 font-mono mt-1 font-bold flex flex-wrap items-center gap-2">
                            {{ item.code }} 
                            <span class="text-blue-600 bg-blue-100 px-1.5 py-0.5 rounded text-[10px]">{{ item.shelf }}</span>
                        </div>
                        <div class="mt-2 flex flex-wrap gap-1">
                            <span v-if="item.units.large.cap > 0" class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-600 border border-gray-200">1{{ item.units.large.name }}={{ item.units.large.cap }}</span>
                            <span v-if="item.units.small.cap > 1" class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-600 border border-gray-200">1{{ item.units.small.name }}={{ item.units.small.cap }}</span>
                        </div>
                    </div>
                    
                    <div class="flex-shrink-0 text-right flex flex-col justify-between h-full min-h-[80px]">
                        <div>
                            <div v-if="isItemComplete(item)" class="text-3xl font-bold text-green-600 leading-none tracking-tight">{{ calculateTotal(item) }}</div>
                            <div v-else class="text-lg font-bold text-red-500 animate-pulse leading-none">æœªç›¤</div>
                            <div class="text-[10px] text-gray-400 mt-1">ç¸½é¡†æ•¸</div>
                        </div>
                        <button v-if="!isItemComplete(item)" @click="setAllZero(item)" class="btn-zero"><span class="text-lg">ğŸ—‘ï¸</span> ç„¡åº«å­˜</button>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-1 rounded p-2 border bg-opacity-50" :class="isItemComplete(item) ? 'bg-gray-50 border-gray-200' : 'bg-white border-red-100'">
                    <div class="text-center flex flex-col" v-if="item.units.large.cap > 0">
                        <label class="text-[11px] text-gray-600 block mb-1 font-bold truncate">{{ item.units.large.name }}</label>
                        <div class="flex items-center justify-center w-full gap-0.5">
                            <button class="btn-unit" @click="updateQty(item, 'large', -1)">-</button>
                            <input type="number" v-model.number="item.inputs.large" @input="debouncedUpdate(item)" 
                                   :class="item.inputs.large === null ? 'input-empty' : 'input-filled'" class="input-box" placeholder="?">
                            <button class="btn-unit" @click="updateQty(item, 'large', 1)">+</button>
                        </div>
                    </div>
                    <div v-else class="flex flex-col justify-center items-center opacity-20"><span class="text-xs">-</span></div>

                    <div class="text-center flex flex-col" v-if="item.units.small.cap > 1">
                        <label class="text-[11px] text-gray-600 block mb-1 font-bold truncate">{{ item.units.small.name }}</label>
                        <div class="flex items-center justify-center w-full gap-0.5">
                            <button class="btn-unit" @click="updateQty(item, 'small', -1)">-</button>
                            <input type="number" v-model.number="item.inputs.small" @input="debouncedUpdate(item)" 
                                   :class="item.inputs.small === null ? 'input-empty' : 'input-filled'" class="input-box" placeholder="?">
                            <button class="btn-unit" @click="updateQty(item, 'small', 1)">+</button>
                        </div>
                    </div>
                    <div v-else class="flex flex-col justify-center items-center opacity-20"><span class="text-xs">-</span></div>

                    <div class="text-center flex flex-col">
                        <label class="text-[11px] text-gray-600 block mb-1 font-bold truncate">é¡†/æ”¯</label>
                        <div class="flex items-center justify-center w-full gap-0.5">
                            <button class="btn-unit" @click="updateQty(item, 'loose', -1)">-</button>
                            <input type="number" v-model.number="item.inputs.loose" @input="debouncedUpdate(item)" 
                                   :class="item.inputs.loose === null ? 'input-empty' : 'input-filled'" class="input-box" placeholder="?">
                            <button class="btn-unit" @click="updateQty(item, 'loose', 1)">+</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div v-if="filteredInventory.length === 0" class="text-center text-gray-400 mt-10 py-10">
                <div class="text-4xl mb-2">ğŸ”</div>
                {{ inventory.length === 0 ? 'è«‹å…ˆåŒ¯å…¥è³‡æ–™' : 'è©²å€åŸŸç„¡æ­¤è—¥å“' }}
            </div>
        </div>
    </div>
</div>

<script>
const { createApp, ref, computed, onMounted } = Vue;

createApp({
    setup() {
        // --- ç‹€æ…‹è®Šæ•¸ ---
        const currentPage = ref('login');
        const currentUser = ref('');
        const currentZone = ref('');
        const searchQuery = ref('');
        const staffList = ref([]);
        const inventory = ref([]);
        
        // ç³»çµ±ç‹€æ…‹
        const isProcessing = ref(false);
        const isOnline = ref(false); // é€£ç·šç‹€æ…‹
        const isSaving = ref(false); // æ­£åœ¨å¯«å…¥é›²ç«¯
        const importSummary = ref({ totalFiles: 0, totalItems: 0 });
        const tempImportData = ref([]);
        const exportTargetZone = ref('');

        // --- Firebase ç›£è½é‚è¼¯ (æ ¸å¿ƒ) ---
        onMounted(() => {
            if (!window.firebaseDb) {
                console.error("Firebase SDK æœªæ­£ç¢ºè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Config");
                return;
            }

            // 1. ç›£è½é€£ç·šç‹€æ…‹
            const connectedRef = window.firebaseRef(window.firebaseDb, ".info/connected");
            window.firebaseOnValue(connectedRef, (snap) => {
                isOnline.value = snap.val() === true;
            });

            // 2. ç›£è½äººå“¡åå–®
            const staffRef = window.firebaseRef(window.firebaseDb, "staff");
            window.firebaseOnValue(staffRef, (snapshot) => {
                const data = snapshot.val();
                if (data) staffList.value = data;
                else staffList.value = [];
            });

            // 3. ç›£è½åº«å­˜è³‡æ–™ (å³æ™‚åŒæ­¥)
            const inventoryRef = window.firebaseRef(window.firebaseDb, "inventory");
            window.firebaseOnValue(inventoryRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // å°‡ç‰©ä»¶è½‰å›é™£åˆ— (Firebase å¯èƒ½æœƒæŠŠé™£åˆ—å­˜æˆç‰©ä»¶)
                    inventory.value = Array.isArray(data) ? data : Object.values(data);
                } else {
                    inventory.value = [];
                }
            });
        });

        // --- é›²ç«¯å¯«å…¥é‚è¼¯ ---
        
        // æ›´æ–°å–®ä¸€é …ç›®çš„é˜²æŠ–å‹• (é¿å…æ‰“å­—æ™‚é »ç¹å¯«å…¥)
        let timeoutMap = {};
        const debouncedUpdate = (item) => {
            isSaving.value = true;
            // å…ˆåœ¨æœ¬åœ°æ¨™è¨˜æœ€å¾Œä¿®æ”¹äºº
            item.user = currentUser.value;
            item.timestamp = new Date().toISOString();
            
            clearTimeout(timeoutMap[item.id]);
            timeoutMap[item.id] = setTimeout(() => {
                saveItemToCloud(item);
            }, 500); // 0.5ç§’å¾Œå¯«å…¥
        };

        // æŒ‰éˆ•é»æ“Šå‰‡æ˜¯ç«‹å³å¯«å…¥
        const updateQty = (item, type, amount) => {
            if (item.inputs[type] === null) item.inputs[type] = 0;
            item.inputs[type] += amount;
            if (item.inputs[type] < 0) item.inputs[type] = 0;
            
            // æ›´æ–°ä¿®æ”¹è³‡è¨Š
            item.user = currentUser.value;
            item.timestamp = new Date().toISOString();
            
            isSaving.value = true;
            saveItemToCloud(item);
        };

        const setAllZero = (item) => {
            if(item.units.large.cap > 0) item.inputs.large = 0;
            if(item.units.small.cap > 1) item.inputs.small = 0;
            item.inputs.loose = 0;
            
            item.user = currentUser.value;
            item.timestamp = new Date().toISOString();
            
            isSaving.value = true;
            saveItemToCloud(item);
        };

        // å¯¦éš›å¯«å…¥ Firebase (åªæ›´æ–°è©²ç­†è³‡æ–™çš„è·¯å¾‘ï¼Œæ•ˆèƒ½æœ€å¥½)
        const saveItemToCloud = (item) => {
            if (!window.firebaseDb) return;
            
            // æ‰¾å‡ºè©² item åœ¨é™£åˆ—ä¸­çš„ç´¢å¼• (Firebase è·¯å¾‘éœ€è¦ index)
            // æ³¨æ„ï¼šé€™è£¡å‡è¨­ inventory é †åºä¸è®Šã€‚è‹¥é †åºæœƒè®Šï¼Œå»ºè­°æ”¹ç”¨ Map çµæ§‹å­˜ã€‚
            const index = inventory.value.findIndex(i => i.id === item.id);
            if (index === -1) return;

            const itemRef = window.firebaseRef(window.firebaseDb, `inventory/${index}`);
            window.firebaseUpdate(itemRef, {
                inputs: item.inputs,
                user: item.user,
                timestamp: item.timestamp
            }).then(() => {
                isSaving.value = false;
                delete timeoutMap[item.id];
            }).catch(e => {
                console.error("å¯«å…¥å¤±æ•—", e);
                isSaving.value = false;
            });
        };

        // --- ç®¡ç†å“¡ä¸Šå‚³ (æ•´æ‰¹è¦†è“‹) ---
        const uploadAllToCloud = async () => {
            if (!window.firebaseDb) return;
            isProcessing.value = true;
            try {
                await window.firebaseSet(window.firebaseRef(window.firebaseDb, "inventory"), inventory.value);
                alert("ç›¤é»è¡¨ä¸Šå‚³é›²ç«¯æˆåŠŸï¼");
            } catch (e) {
                alert("ä¸Šå‚³å¤±æ•—ï¼š" + e.message);
            } finally {
                isProcessing.value = false;
            }
        };

        const uploadStaffToCloud = async () => {
            if (!window.firebaseDb) return;
            try {
                await window.firebaseSet(window.firebaseRef(window.firebaseDb, "staff"), staffList.value);
                alert("äººå“¡åå–®ä¸Šå‚³æˆåŠŸï¼");
            } catch (e) {
                alert("ä¸Šå‚³å¤±æ•—ï¼š" + e.message);
            }
        };

        const clearCloudStaff = async () => {
            if(!confirm("ç¢ºå®šæ¸…ç©ºé›²ç«¯äººå“¡åå–®ï¼Ÿ")) return;
            await window.firebaseRemove(window.firebaseRef(window.firebaseDb, "staff"));
        };

        const clearCloudInventory = async () => {
            if(!confirm("å±éšªï¼šç¢ºå®šæ¸…ç©ºé›²ç«¯æ‰€æœ‰ç›¤é»è³‡æ–™ï¼Ÿ")) return;
            await window.firebaseRemove(window.firebaseRef(window.firebaseDb, "inventory"));
        };

        // --- æª”æ¡ˆè™•ç† (æœ¬åœ°è§£æ -> æº–å‚™ä¸Šå‚³) ---
        // (é€™éƒ¨åˆ†é‚è¼¯èˆ‡ä¹‹å‰ç›¸åŒï¼Œåªæ˜¯æœ€å¾Œå‹•ä½œæ”¹ç‚º call upload)
        
        const handleStaffUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                let raw = e.target.result.replace(/äººå“¡åå–®/g, '').replace(/\r\n/g, ',').replace(/\n/g, ',');
                const names = raw.split(',').map(s => s.trim()).filter(s => s.length > 0);
                if (names.length > 0) {
                    staffList.value = names;
                    uploadStaffToCloud();
                }
            };
            reader.readAsText(file);
        };

        const handleFileUpload = async (event) => {
            const files = event.target.files;
            if (!files.length) return;
            isProcessing.value = true;
            tempImportData.value = [];
            importSummary.value = { totalFiles: 0, totalItems: 0 };
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                let zoneName = file.name.replace('.csv','').replace('.xlsx','').replace('.xls','');
                const match = zoneName.match(/-\s*(.+)/); 
                if (match && match[1]) zoneName = match[1].trim();
                try {
                    const data = await parseSingleFile(file, zoneName);
                    tempImportData.value = [...tempImportData.value, ...data];
                    importSummary.value.totalFiles++;
                } catch(e) {}
            }
            importSummary.value.totalItems = tempImportData.value.length;
            isProcessing.value = false;
        };

        const confirmImport = () => {
            if (confirm(`æº–å‚™å°‡ ${importSummary.value.totalItems} ç­†è³‡æ–™ä¸Šå‚³è‡³é›²ç«¯ï¼Ÿ\né€™æœƒè¦†è“‹ç¾æœ‰é›²ç«¯è³‡æ–™åº«ï¼`)) {
                inventory.value = tempImportData.value;
                uploadAllToCloud();
                tempImportData.value = [];
                importSummary.value = { totalFiles: 0, totalItems: 0 };
            }
        };

        // --- Excel è§£æ (ç¶­æŒä¸è®Š) ---
        const parseSingleFile = (file, zoneName) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1, defval: '' });
                    resolve(processRows(rows, zoneName));
                };
                reader.readAsArrayBuffer(file);
            });
        };
        const processRows = (rows, zoneName) => {
            if (!rows || rows.length === 0) return [];
            let headerIdx = -1, colMap = {};
            for (let i = 0; i < Math.min(rows.length, 20); i++) {
                const rowStr = rows[i].map(c => String(c).trim());
                if (rowStr.includes('ä»£ç¢¼') && (rowStr.includes('åç¨±') || rowStr.includes('è—¥å“åç¨±'))) {
                    headerIdx = i;
                    rows[i].forEach((col, idx) => {
                        const c = String(col).trim();
                        if (c.includes('ä»£ç¢¼')) colMap.code = idx;
                        else if (c.includes('åç¨±')) colMap.name = idx;
                        else if (c.includes('é–€ç‰Œ') || c.includes('å„²ä½')) colMap.shelf = idx;
                        else if (c.includes('å¤§åŒ…è£') && c.includes('é‡')) colMap.lgCap = idx;
                        else if (c.includes('å¤§åŒ…è£') && (c.includes('å–®ä½') || c.includes('/'))) colMap.lgUnit = idx;
                        else if (c.includes('å°åŒ…è£') && c.includes('é‡')) colMap.smCap = idx;
                        else if (c.includes('å°åŒ…è£') && (c.includes('å–®ä½') || c.includes('/'))) colMap.smUnit = idx;
                    });
                    break;
                }
            }
            if (headerIdx === -1) return [];
            const items = [];
            for (let i = headerIdx + 1; i < rows.length; i++) {
                const row = rows[i];
                const code = row[colMap.code];
                const name = row[colMap.name];
                if (!code || !name) continue;
                let lgCap = 0, lgUnit = 'ç›’';
                if (colMap.lgCap !== undefined) {
                    const val = parseInt(row[colMap.lgCap]);
                    if (!isNaN(val)) lgCap = val;
                    if (row[colMap.lgCap+1] && String(row[colMap.lgCap+1]).includes('/')) lgUnit = String(row[colMap.lgCap+1]).replace('/','').replace('x','').trim();
                }
                let smCap = 1, smUnit = 'æ’';
                if (colMap.smCap !== undefined) {
                    const val = parseInt(row[colMap.smCap]);
                    if (!isNaN(val)) smCap = val;
                    if (row[colMap.smCap+1] && String(row[colMap.smCap+1]).includes('/')) smUnit = String(row[colMap.smCap+1]).replace('/','').replace('x','').trim();
                }
                items.push({
                    id: `${code}_${zoneName}_${i}`,
                    code: String(code).trim(),
                    name: String(name).trim(),
                    shelf: colMap.shelf !== undefined ? String(row[colMap.shelf]).trim() : '',
                    zone: zoneName,
                    units: { large: { name: lgUnit, cap: lgCap }, small: { name: smUnit, cap: smCap }, loose: { name: 'é¡†', cap: 1 } },
                    inputs: { large: null, small: null, loose: null },
                    timestamp: null, user: null
                });
            }
            return items;
        };

        // --- å…¶ä»–å…±ç”¨å‡½å¼ ---
        const enterAdmin = () => {
            if(prompt("è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ï¼š") === "8888") currentPage.value = 'admin';
            else alert("å¯†ç¢¼éŒ¯èª¤");
        };
        const enterSystem = () => currentPage.value = 'inventory';
        const exitCounting = () => currentPage.value = 'login';
        
        const uniqueZones = computed(() => {
            if(!inventory.value) return [];
            return Array.from(new Set(inventory.value.map(i => i.zone))).sort();
        });
        
        const isItemComplete = (item) => {
            const l = item.units.large.cap > 0 ? item.inputs.large !== null : true;
            const s = item.units.small.cap > 1 ? item.inputs.small !== null : true;
            const loose = item.inputs.loose !== null;
            return l && s && loose;
        };
        const calculateTotal = (item) => {
            if (!isItemComplete(item)) return 0;
            return (item.inputs.large || 0) * item.units.large.cap + (item.inputs.small || 0) * item.units.small.cap + (item.inputs.loose || 0);
        };

        // --- ç¯©é¸èˆ‡å ±è¡¨ ---
        const filteredInventory = computed(() => {
            if(!inventory.value) return [];
            let list = inventory.value.filter(i => i.zone === currentZone.value);
            if (searchQuery.value) {
                const q = searchQuery.value.toLowerCase();
                list = list.filter(i => i.name.toLowerCase().includes(q) || i.code.toLowerCase().includes(q));
            }
            return list;
        });
        const uncountedCount = computed(() => filteredInventory.value.filter(i => !isItemComplete(i)).length);
        const progressPercent = computed(() => {
            const total = filteredInventory.value.length;
            return total === 0 ? 0 : ((total - uncountedCount.value) / total) * 100;
        });
        const currentZoneStats = computed(() => {
            const total = filteredInventory.value.length;
            const done = total - uncountedCount.value;
            return { total, done, percent: total===0?0:Math.round((done/total)*100) };
        });
        const zoneProgress = computed(() => {
            if(!inventory.value) return [];
            const stats = {};
            uniqueZones.value.forEach(z => stats[z] = { total: 0, done: 0 });
            inventory.value.forEach(item => {
                if (stats[item.zone]) {
                    stats[item.zone].total++;
                    if (isItemComplete(item)) stats[item.zone].done++;
                }
            });
            return Object.keys(stats).map(zone => ({
                name: zone,
                total: stats[zone].total,
                done: stats[zone].done,
                percent: stats[zone].total === 0 ? 0 : Math.round((stats[zone].done / stats[zone].total) * 100)
            }));
        });

        const exportZone = (zoneName) => {
            const targetItems = inventory.value.filter(i => i.zone === zoneName);
            const exportData = targetItems.map(item => {
                const finished = isItemComplete(item);
                let details = [];
                if (item.units.large.cap > 0 && item.inputs.large !== null) details.push(`${item.inputs.large}${item.units.large.name}`);
                if (item.units.small.cap > 1 && item.inputs.small !== null) details.push(`${item.inputs.small}${item.units.small.name}`);
                if (item.inputs.loose !== null && item.inputs.loose > 0) details.push(`${item.inputs.loose}é¡†`);
                if (finished && details.length === 0) details.push("0");
                return {
                    'è—¥å“ä»£ç¢¼': item.code, 'è—¥å“åç¨±': item.name, 'æ«ƒä½': item.shelf,
                    'ç›¤é»å…§å®¹': finished ? details.join(' ') : 'æœªç›¤é»',
                    'ç¸½é‡(æœ€å°å–®ä½)': finished ? calculateTotal(item) : '',
                    'ç›¤é»äºº': finished ? (item.user || '') : '',
                    'ç›¤é»æ™‚é–“': finished && item.timestamp ? new Date(item.timestamp).toLocaleString() : ''
                };
            });
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç›¤é»æ˜ç´°");
            XLSX.writeFile(wb, `ç›¤é»æ˜ç´°_${zoneName}_${new Date().toISOString().slice(0,10)}.xlsx`);
        };

        const exportMasterPivotReport = () => {
            const zones = uniqueZones.value;
            const itemMap = {};
            inventory.value.forEach(item => {
                if (!itemMap[item.code]) itemMap[item.code] = { code: item.code, name: item.name, totalsByZone: {} };
                if (isItemComplete(item)) itemMap[item.code].totalsByZone[item.zone] = calculateTotal(item);
                else itemMap[item.code].totalsByZone[item.zone] = 0;
            });
            const exportData = Object.values(itemMap).map(row => {
                const excelRow = { 'è—¥å“ä»£ç¢¼': row.code, 'è—¥å“åç¨±': row.name };
                let grandTotal = 0;
                zones.forEach(z => {
                    const val = row.totalsByZone[z] || 0;
                    excelRow[z] = val;
                    grandTotal += val;
                });
                excelRow['å…¨é™¢ç¸½è¨ˆ'] = grandTotal;
                return excelRow;
            });
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "åº«å­˜ç¸½è¡¨");
            XLSX.writeFile(wb, `åº«å­˜ç¸½è¡¨_å…¨é™¢_${new Date().toISOString().slice(0,10)}.xlsx`);
        };

        return {
            currentPage, currentUser, currentZone, staffList, inventory, searchQuery, filteredInventory,
            uncountedCount, progressPercent, uniqueZones, zoneProgress, currentZoneStats,
            isProcessing, isOnline, isSaving, importSummary, handleFileUpload, confirmImport, clearInventory, clearStaff, handleStaffUpload, clearCloudStaff, clearCloudInventory,
            enterSystem, exitCounting, isItemComplete, calculateTotal, setAllZero, updateQty, debouncedUpdate,
            exportZone, exportMasterPivotReport, enterAdmin
        };
    }
}).mount('#app');
</script>
</body>
</html>
